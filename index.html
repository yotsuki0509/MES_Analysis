<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå¹³å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 1.0rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 30px; 
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 15px; font-weight: 800; }
        .header p { font-size: 1.1rem; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-section { padding: 35px; border-bottom: 2px solid #f0f0f0; }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px; 
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover { background: rgba(102, 126, 234, 0.1); border-color: #5a6fd8; }
        .upload-area.dragover { background: rgba(102, 126, 234, 0.15); border-color: #4A5FC7; }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; color: #667eea; }
        .upload-area h3 { font-size: 1.4rem; }
        
        .path-input-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9ff; border-radius: 10px; border-left: 4px solid #667eea;
        }
        /* API Key è¼¸å…¥å€å¡Šæ¨£å¼ */
        .api-key-section {
            margin-top: 15px;
            padding: 20px;
            background: #fff0f5; 
            border-radius: 10px; 
            border-left: 4px solid #E94B8C;
        }

        .path-input {
            width: 100%;
            padding: 12px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 1rem; margin-top: 15px;
        }
        
        /* æ—¥æœŸé¸æ“‡èˆ‡æŒ‰éˆ• */
        .date-selector {
            display: flex;
            gap: 20px; justify-content: center;
            align-items: center; margin-top: 25px; flex-wrap: wrap; font-size: 1rem;
        }
        .date-group { display: flex; align-items: center; gap: 10px; }
        .date-input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;
        }
        .date-input:focus { outline: none; border-color: #667eea; }
        
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 30px; 
            border-radius: 30px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: transform 0.2s;
        }
        .analyze-btn:hover { transform: translateY(-2px); }
        .analyze-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        /* å„€è¡¨æ¿èˆ‡å¡ç‰‡ */
        .dashboard { padding: 35px 30px; display: none; }
        .dashboard.show { display: block; }
        
        .date-range-display {
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px; border-radius: 12px; margin-bottom: 30px;
            font-size: 2.2rem; font-weight: 700; color: #333;
        }
        
        .section-subtitle {
            font-size: 2.6rem;
            font-weight: 700; color: #333;
            margin-bottom: 22px; text-align: center;
            background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 15px;
        }
        
        .factory-row { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .factory-card {
            background: white;
            border-radius: 16px; padding: 25px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: transform 0.3s ease;
        }
        .factory-card:hover { transform: translateY(-5px); }
        
        .factory-title {
            font-size: 1.8rem;
            font-weight: 700; margin-bottom: 15px;
            text-align: center; padding: 15px; border-radius: 12px; color: white;
        }
        .molding-title { background: linear-gradient(135deg, #4A90E2, #357ABD); }
        .assembly-title { background: linear-gradient(135deg, #E94B8C, #D63384); }
        
        /* çµ±è¨ˆæ•¸å­— */
        .stats-group-title {
            font-size: 1.4rem;
            font-weight: 600; color: #4A90E2;
            margin-bottom: 8px; padding-bottom: 6px; border-bottom: 3px solid #E3F2FD;
        }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 4px 0; }
        .stat-label { color: #444; font-weight: 500; font-size: 1.3rem; }
        .stat-value { font-weight: 700; color: #333; font-size: 1.3rem; }
        
        /* åœ–è¡¨å€åŸŸ (å–®æœˆ) */
        .detailed-chart-section {
            display: grid;
            grid-template-columns: 1fr 1fr; gap: 30px;
            margin-top: 25px; padding-top: 15px; border-top: 2px solid #f0f0f0;
        }
        .detailed-chart-container {
            height: 450px;
            padding: 15px; 
            padding-bottom: 30px;
            background: #f8f9ff; border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            position: relative; width: 100%; overflow: hidden;
        }
        .detailed-chart-title {
            text-align: center;
            font-size: 1.6rem; font-weight: 800;
            color: #4A90E2; margin-bottom: 20px; letter-spacing: 1px;
        }
        
        /* è¶¨å‹¢åœ–è¡¨å€åŸŸ (å¤šæœˆ) */
        .trend-chart-section {
            display: grid;
            grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 40px; background: white; padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .trend-controls {
            display: flex;
            justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 20px; padding: 15px;
            background: #f0f2ff; border-radius: 10px; border: 1px solid #dbeafe;
        }
        .trend-controls h4 { color: #667eea; font-weight: 700; margin-right: 10px; }
        .mini-btn {
            background: #4A90E2;
            color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
        }
        .mini-btn:hover { background: #357ABD; }

        /* äººå“¡åˆ†æ */
        .full-width-personnel-section {
            display: grid;
            grid-template-columns: 1fr 1fr; gap: 30px;
            margin-top: 25px; padding-top: 15px; border-top: 2px solid #f0f0f0;
        }
        .personnel-section {
            padding: 12px;
            background: #f8f9ff; border-radius: 15px; border-left: 5px solid #4A90E2;
        }
        .personnel-title {
            font-size: 1.4rem;
            font-weight: 700; color: #4A90E2; margin-bottom: 12px; text-align: center;
        }
        .personnel-item {
            background: white;
            padding: 8px 15px; margin-bottom: 5px;
            border-radius: 8px; display: flex; justify-content: space-between;
            border-left: 4px solid #E94B8C; font-size: 1.25rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .personnel-name { font-weight: 600; color: #333; }
        .personnel-count { font-weight: 700; color: #E94B8C; }
        .no-personnel {
            color: #28a745;
            font-style: italic; text-align: center;
            padding: 15px; font-size: 1.1rem; font-weight: 600;
        }
        
        /* æ´å¯Ÿå»ºè­° */
        .insights {
            background: white;
            border-radius: 16px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            margin-top: 30px;
        }
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;
        }
        .insight-item {
            background: #f8f9ff;
            border-left: 5px solid #667eea; padding: 15px; border-radius: 10px;
        }
        .insight-item h4 {
            color: #667eea;
            margin-bottom: 12px; font-size: 1.5rem;
            font-weight: 700; text-align: left;
        }
        .insight-content-box {
            margin-top: 10px;
            padding: 12px 15px; border-radius: 8px;
            background-color: white; border: 1px solid #e0e7ff;
        }
        .insight-content-box p, .insight-content-box li {
            color: #333;
            line-height: 1.6; font-size: 1.28rem;
            margin-bottom: 8px; text-align: justify;
        }
        .insight-content-box li { margin-bottom: 8px; padding-left: 25px; text-indent: -20px; list-style: none; }
        .insight-content-box li::before {
            content: "â”";
            font-weight: bold; color: #E94B8C; margin-right: 10px; font-size: 1.1rem;
        }
        
        /* å¯ç·¨è¼¯å€åŸŸæ¨£å¼ */
        .editable-advice-box {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
            font-size: 1.2rem;
            line-height: 1.6;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .editable-advice-box:focus {
            border-color: #4A5FC7;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
            border-style: solid;
        }
        .editable-advice-box:empty:before {
            content: attr(placeholder);
            color: #999;
            font-style: italic;
        }

        /* é è¦½èˆ‡è¼‰å…¥ */
        .loading { display: none; text-align: center; padding: 30px; font-size: 1.4rem; color: #667eea; font-weight: 600; }
        .loading.show { display: block; }
        .preview-section {
            margin-top: 25px;
            padding: 20px; background: #f8f9fa;
            border-radius: 10px; border-left: 5px solid #667eea; font-size: 1rem;
        }
        .field-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .field-item {
            background: white;
            padding: 10px 15px; border-radius: 6px;
            font-size: 0.95rem; border-left: 4px solid #28a745;
        }
        .field-item.missing { border-left-color: #dc3545; }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px; border-radius: 15px;
            width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 20px; color: #4A5FC7; text-align: center; }
        .checkbox-item {
            display: flex;
            align-items: center; justify-content: space-between;
            margin-bottom: 12px; padding: 10px; border-radius: 8px;
            background: #f8f9ff; transition: background 0.2s;
        }
        .checkbox-item:hover { background: #f0f2ff; }
        .checkbox-label { flex-grow: 1; font-size: 1rem; display: flex; align-items: center; cursor: pointer; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; }
        .move-btn {
            background: #fff;
            border: 1px solid #ccc; border-radius: 4px;
            padding: 2px 8px; cursor: pointer; font-size: 0.8rem;
        }
        .move-btn:hover { background: #eee; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .cancel-btn { background: #eee; color: #666; }

        /* é å°¾æ¨£å¼ */
        .report-footer {
            margin-top: 50px;
            padding-top: 20px;
            padding-bottom: 20px; 
            border-top: 1px solid #e0e0e0;
            text-align: center;
            background-color: white;
        }
        .report-footer h3 {
            color: #333;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .report-footer p {
            color: #888;
            font-size: 0.9rem;
        }

        @media (min-width: 1024px) {
            .insight-grid { grid-template-columns: 1fr 1fr; }
            .insight-item.span-full { grid-column: 1 / -1; }
        }
        @media (max-width: 768px) {
            .factory-row, .detailed-chart-section, .full-width-personnel-section, .trend-chart-section { grid-template-columns: 1fr; }
            .date-selector, .trend-controls { flex-direction: column; gap: 15px; }
            .header h1 { font-size: 2rem; }
            .section-subtitle { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå¹³å°</h1>
            <p>è£½é€ åŸ·è¡Œç³»çµ± Â· ç¾å ´å ±å·¥æ•¸æ“šåˆ†æ -- Crafted by å‹å…¨ Â· AI-assisted analytics (MES data)</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h3>ä¸Šå‚³Excelæª”æ¡ˆæˆ–æ‹–æ‹½è‡³æ­¤</h3>
                <p>æ”¯æ´ .xlsx, .xls æ ¼å¼ï¼Œå°‡è‡ªå‹•è®€å–ã€Œç´€éŒ„å–®ã€å·¥ä½œè¡¨</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="path-input-section">
                <h4>æˆ–è¼¸å…¥å…§ç¶²æª”æ¡ˆè·¯å¾‘</h4>
                <input type="text" id="pathInput" class="path-input" 
                       placeholder="ä¾‹å¦‚ï¼š\\server\shared\MESå ±å·¥æ•¸æ“šä¿®æ­£æ˜ç´°.xlsx" disabled>
                <small>æ³¨æ„ï¼šå…§ç¶²è·¯å¾‘åŠŸèƒ½éœ€è¦åœ¨å…§ç¶²ç’°å¢ƒä¸­ä½¿ç”¨</small>
            </div>

            <div class="api-key-section">
                <h4>ğŸ¤– AI é¡§å•è¨­å®š (é¸å¡«)</h4>
                <input type="password" id="apiKey" class="path-input" 
                       placeholder="è«‹è¼¸å…¥ Gemini API Key (å¦‚æœªå¡«å¯«å‰‡ä¸é¡¯ç¤º AI é¡§å•å€å¡Š)" 
                       style="margin-top: 10px; border-color: #E94B8C;">
                <small>ä½¿ç”¨æ¨¡å‹ï¼šGemini 2.5 Flash (ç©©å®šç‰ˆ)ã€‚è«‹ç¢ºä¿ Key å…·æœ‰ generateContent æ¬Šé™ã€‚</small>
            </div>
            
            <div class="date-selector">
                <div class="date-group">
                    <label for="startDate">åˆ†æèµ·å§‹æ—¥ï¼š</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <div class="date-group">
                    <label for="endDate">åˆ†æçµæŸæ—¥ï¼š</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
                <button id="analyzeBtn" class="analyze-btn" disabled>é–‹å§‹åˆ†æ</button>
            </div>
        </div>
        
        <div class="loading" id="loading"><div>ğŸ”„ æ­£åœ¨åˆ†ææ•¸æ“šä¸­...</div></div>
        
        <div class="dashboard" id="dashboard">
            <div style="text-align: right; margin-bottom: 20px;">
                <button id="openExportModalBtn" class="analyze-btn">åŒ¯å‡ºå ±è¡¨ç‚ºPDF</button>
            </div>
            
            <div id="pdfContentWrapper" class="bg-white p-2">
                <div id="pdfTitleHeader" style="display:none; text-align:center; padding: 20px 0;">
                    <h1 style="font-size: 50px; font-weight: bold; margin-bottom: 10px;">MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå ±å‘Š</h1>
                    <div style="font-size: 18px; color: #666;" id="pdfDateDisplay"></div>
                </div>

                <div class="date-range-display" id="dateRangeDisplay"></div>
                
                <div id="trendBlock" style="display:none;">
                    <div class="section-subtitle">ğŸ“ˆ ç•°å¸¸è¶¨å‹¢èµ°å‹¢åˆ†æ</div>
                    
                    <div class="trend-controls">
                        <h4>è¶¨å‹¢åœ–è¡¨æ™‚é–“è¨­å®šï¼š</h4>
                        <div class="date-group">
                            <label>èµ·å§‹æœˆ</label>
                            <input type="month" id="trendStartMonth" class="date-input" style="padding: 5px;">
                        </div>
                        <div class="date-group">
                            <label>çµæŸæœˆ</label>
                            <input type="month" id="trendEndMonth" class="date-input" style="padding: 5px;">
                        </div>
                        <button id="updateTrendBtn" class="mini-btn">æ›´æ–°è¶¨å‹¢åœ–è¡¨</button>
                    </div>

                    <div class="trend-chart-section">
                        <div class="detailed-chart-container">
                            <div class="detailed-chart-title">å„å» å€æ¯æœˆç•°å¸¸ç¸½é‡è¶¨å‹¢ (æŠ˜ç·šåœ–)</div>
                            <canvas id="trendMainChart"></canvas>
                        </div>
                        <div class="detailed-chart-container">
                            <div class="detailed-chart-title">å„å» å€æ¯æœˆç¸½æ¡ˆä»¶é‡å †ç–Š (æŸ±ç‹€åœ–)</div>
                            <canvas id="trendVolumeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="moldingBlock">
                    <div class="section-subtitle">ğŸ”§ æˆå‹éƒ¨é–€ç¾æ³ (å–®æœˆåˆ†æ)</div>
                    <div class="factory-row">
                        <div class="factory-card">
                            <div class="factory-title molding-title">å®—ç‘‹å»  - æˆå‹éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š ç­åˆ¥çµ±è¨ˆ</div>
                                <div class="stats-row"><span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="zongweiMoldingTotal">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">æ—¥ç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="zongweiMoldingDay">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">å¤œç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="zongweiMoldingNight">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="zongweiMoldingIssues"></div></div>
                        </div>
                        <div class="factory-card">
                            <div class="factory-title molding-title">åšå£«å»  - æˆå‹éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š ç­åˆ¥çµ±è¨ˆ</div>
                                <div class="stats-row"><span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="bossMoldingTotal">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">æ—¥ç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="bossMoldingDay">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">å¤œç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="bossMoldingNight">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="bossMoldingIssues"></div></div>
                        </div>
                    </div>
                    
                    <div class="detailed-chart-section">
                        <div class="detailed-chart-container">
                            <div class="detailed-chart-title">å®—ç‘‹å»  - ç­åˆ¥èˆ‡å•é¡Œåˆ†æ (æˆå‹)</div>
                            <canvas id="zongweiMoldingDetailedChart"></canvas>
                        </div>
                        <div class="detailed-chart-container">
                            <div class="detailed-chart-title">åšå£«å»  - ç­åˆ¥èˆ‡å•é¡Œåˆ†æ (æˆå‹)</div>
                            <canvas id="bossMoldingDetailedChart"></canvas>
                        </div>
                    </div>

                    <div class="full-width-personnel-section">
                        <div class="personnel-section">
                            <div class="personnel-title" id="zongweiMoldingPersonnelTitle">å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="zongweiMoldingPersonnel"></div>
                        </div>
                        <div class="personnel-section">
                            <div class="personnel-title" id="bossMoldingPersonnelTitle">åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="bossMoldingPersonnel"></div>
                        </div>
                    </div>
                </div>
                
                <div id="assemblyBlock" class="mt-8">
                    <div class="section-subtitle">ğŸ“¦ çµ„è£éƒ¨é–€ç¾æ³ (å–®æœˆåˆ†æ)</div>
                    <div class="factory-row">
                        <div class="factory-card">
                            <div class="factory-title assembly-title">å®—ç‘‹å»  - çµ„è£éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š åŸºæœ¬çµ±è¨ˆ</div>
                                <div class="stats-row"><span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="zongweiAssemblyTotal">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">æ—¥ç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="zongweiAssemblyDay">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">å¤œç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="zongweiAssemblyNight">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="zongweiAssemblyIssues"></div></div>
                        </div>
                        <div class="factory-card">
                            <div class="factory-title assembly-title">åšå£«å»  - çµ„è£éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š åŸºæœ¬çµ±è¨ˆ</div>
                                <div class="stats-row"><span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="bossAssemblyTotal">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">æ—¥ç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="bossAssemblyDay">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">å¤œç­ç™¼ç”Ÿæ¬¡æ•¸</span><span class="stat-value" id="bossAssemblyNight">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="bossAssemblyIssues"></div></div>
                        </div>
                    </div>

                    <div class="full-width-personnel-section">
                        <div class="personnel-section">
                            <div class="personnel-title" id="zongweiAssemblyPersonnelTitle">å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="zongweiAssemblyPersonnel"></div>
                        </div>
                        <div class="personnel-section">
                            <div class="personnel-title" id="bossAssemblyPersonnelTitle">åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="bossAssemblyPersonnel"></div>
                        </div>
                    </div>
                </div>
                
                <div class="insights mt-8" id="insightsSection">
                    <div class="section-subtitle">ğŸ“Š å®¢è§€ç¾æ³è§€å¯Ÿèˆ‡å»ºè­°</div>
                    <div class="insight-grid" id="insightsGrid"></div>
                </div>

                <div class="insights mt-8" id="aiBlock" style="display:none;">
                    <div class="section-subtitle">ğŸ¤– AI é¡§å•ç­–ç•¥å»ºè­° (Gemini)</div>
                    <div id="aiContent"></div>
                </div>
                
                <div id="reportFooter" class="report-footer">
                    <h3>å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯ç¹« MIS Team</h3>
                    <p>Crafted by å‹å…¨ Â· AI-assisted analytics (MES data)</p>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px dashed #ccc; display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
                        <div style="padding: 0 30px; text-align: center; border-right: 1px solid #e0e0e0;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #444; margin-bottom: 5px;">éœå¨Ÿ</div>
                            <div style="font-size: 0.95rem; color: #888;">å®—ç‘‹å»  #291</div>
                        </div>
                        <div style="padding: 0 30px; text-align: center; border-right: 1px solid #e0e0e0;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #444; margin-bottom: 5px;">å‹å…¨</div>
                            <div style="font-size: 0.95rem; color: #888;">å®—ç‘‹å»  #297</div>
                        </div>
                        <div style="padding: 0 30px; text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #444; margin-bottom: 5px;">æ€¡æ½”</div>
                            <div style="font-size: 0.95rem; color: #888;">åšå£«å»  #356</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“„ PDF åŒ¯å‡ºé †åºè¨­å®š</div>
            <p style="text-align: center; margin-bottom: 15px; font-size: 0.9rem; color: #666;">
                è«‹å‹¾é¸è¦åŒ¯å‡ºçš„å€å¡Šï¼Œä¸¦ä½¿ç”¨æŒ‰éˆ•èª¿æ•´é †åº
            </p>
            <div class="sortable-list" id="exportSortableList">
                <div class="checkbox-item sortable-item" data-id="moldingBlock">
                    <label class="checkbox-label"><input type="checkbox" checked> 1. ğŸ”§ æˆå‹éƒ¨é–€ç¾æ³</label>
                    <div class="order-btns"><button class="move-btn" onclick="moveUp(this)">â¬†ï¸</button><button class="move-btn" onclick="moveDown(this)">â¬‡ï¸</button></div>
                </div>
                <div class="checkbox-item sortable-item" data-id="assemblyBlock">
                    <label class="checkbox-label"><input type="checkbox" checked> 2. ğŸ“¦ çµ„è£éƒ¨é–€ç¾æ³</label>
                    <div class="order-btns"><button class="move-btn" onclick="moveUp(this)">â¬†ï¸</button><button class="move-btn" onclick="moveDown(this)">â¬‡ï¸</button></div>
                </div>
                <div class="checkbox-item sortable-item" data-id="trendBlock">
                    <label class="checkbox-label"><input type="checkbox" checked> 3. ğŸ“ˆ ç•°å¸¸è¶¨å‹¢èµ°å‹¢åˆ†æ</label>
                    <div class="order-btns"><button class="move-btn" onclick="moveUp(this)">â¬†ï¸</button><button class="move-btn" onclick="moveDown(this)">â¬‡ï¸</button></div>
                </div>
                <div class="checkbox-item sortable-item" data-id="insightsSection">
                    <label class="checkbox-label"><input type="checkbox" checked> 4. ğŸ“Š å®¢è§€è§€å¯Ÿèˆ‡æµç¨‹å»ºè­°</label>
                    <div class="order-btns"><button class="move-btn" onclick="moveUp(this)">â¬†ï¸</button><button class="move-btn" onclick="moveDown(this)">â¬‡ï¸</button></div>
                </div>
                <div class="checkbox-item sortable-item" data-id="aiBlock">
                    <label class="checkbox-label"><input type="checkbox" checked> 5. ğŸ¤– AI é¡§å•ç­–ç•¥å»ºè­°</label>
                    <div class="order-btns"><button class="move-btn" onclick="moveUp(this)">â¬†ï¸</button><button class="move-btn" onclick="moveDown(this)">â¬‡ï¸</button></div>
                </div>
            </div>
            <div class="modal-btns">
                <button id="cancelPdfBtn" class="analyze-btn cancel-btn flex-1">å–æ¶ˆ</button>
                <button id="confirmPdfBtn" class="analyze-btn flex-1">ç¢ºèªåŒ¯å‡º</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- å…¨åŸŸè®Šæ•¸å®£å‘Š ---
        let excelData = [];
        let charts = {};
        const TARGET_FIELDS = ['å» åˆ¥', 'éƒ¨é–€', 'èª¿æ•´æ—¥æœŸ', 'å ±å·¥äººå“¡1', 'ç­åˆ¥', 'èª¿æ•´åŸå› '];
        const MAIN_ISSUES = ['æ¼å ±å·¥', 'æ•¸é‡éŒ¯èª¤', 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)', 'å…¶ä»–/æœªåˆ†é¡'];

        // --- è¼”åŠ©å·¥å…· ---
        function excelDateToISOString(serial) {
            if (typeof serial !== 'number' || isNaN(serial) || serial <= 0) return null;
            const baseDate = new Date(Date.UTC(1899, 11, 30));
            const date = new Date(baseDate.getTime() + (serial * 24 * 60 * 60 * 1000));
            if (isNaN(date.getTime())) return null; 
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setDefaultDates() {
            const today = new Date();
            const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const formatMonth = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('startDate').value = formatDate(firstDayLastMonth);
            document.getElementById('endDate').value = formatDate(lastDayLastMonth);
            document.getElementById('trendEndMonth').value = formatMonth(lastDayLastMonth);
            const sixMonthsAgo = new Date(lastDayLastMonth);
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
            document.getElementById('trendStartMonth').value = formatMonth(sixMonthsAgo);
        }
        
        // --- æª”æ¡ˆèˆ‡äº‹ä»¶ç›£è½ ---
        function setupListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const updateTrendBtn = document.getElementById('updateTrendBtn');
            const openExportModalBtn = document.getElementById('openExportModalBtn');
            const cancelPdfBtn = document.getElementById('cancelPdfBtn');
            const confirmPdfBtn = document.getElementById('confirmPdfBtn');
            const exportModal = document.getElementById('exportModal');

            // ä¸Šå‚³å€å¡Š
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault(); uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });

            // æŒ‰éˆ•åŠŸèƒ½
            analyzeBtn.addEventListener('click', analyzeData);
            updateTrendBtn.addEventListener('click', () => { if(excelData.length > 0) generateTrendCharts(excelData); });
            
            // åŒ¯å‡ºå½ˆçª—æ§åˆ¶
            openExportModalBtn.addEventListener('click', () => {
                // æª¢æŸ¥æ˜¯å¦å·²åˆ†æ
                if(excelData.length === 0 || !charts['trendMain']) {
                    alert('è«‹å…ˆä¸Šå‚³æª”æ¡ˆä¸¦å®Œæˆåˆ†æå¾Œï¼Œæ‰èƒ½åŒ¯å‡º PDFã€‚');
                    return;
                }
                // æª¢æŸ¥å‡½å¼åº«æ˜¯å¦è¼‰å…¥æˆåŠŸ (é—œéµæª¢æŸ¥)
                if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                    alert('âš ï¸ ç³»çµ±éŒ¯èª¤ï¼šPDF æ ¸å¿ƒå…ƒä»¶æœªè¼‰å…¥ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. å…¬å¸å…§ç¶²é˜»æ“‹äº† CDN é€£ç·š\n2. ç¶²è·¯é€£ç·šä¸­æ–·\n\nè§£æ±ºæ–¹æ³•ï¼š\nè«‹ç¢ºä¿ç¶²è·¯å¯é€£æ¥å¤–ç¶² (cdnjs.cloudflare.com)ã€‚');
                    return;
                }
                exportModal.style.display = 'flex';
            });
            cancelPdfBtn.addEventListener('click', () => exportModal.style.display = 'none');
            confirmPdfBtn.addEventListener('click', exportSelectedPdf);
            
            window.onclick = (e) => { if(e.target == exportModal) exportModal.style.display = 'none'; };
        }
        
        // --- æª”æ¡ˆè™•ç† ---
        function handleFile(file) {
            // ä¿®æ­£å¾Œï¼šå³ä½¿å‡½å¼åº«æœªè¼‰å…¥ï¼Œé¡¯ç¤ºæ›´æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯
            if (typeof XLSX === 'undefined') { 
                alert('âš ï¸ ç³»çµ±éŒ¯èª¤ï¼šExcel å…ƒä»¶æœªè¼‰å…¥ã€‚\n\nè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šï¼Œæˆ–ç¢ºèªå…¬å¸é˜²ç«ç‰†æ˜¯å¦é˜»æ“‹äº† cdnjs.cloudflare.comã€‚\n\nå˜—è©¦é‡æ–°æ•´ç†é é¢å¯èƒ½æœƒæœ‰å¹«åŠ©ã€‚'); 
                return; 
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: false}); 
                    let targetSheet = workbook.Sheets['ç´€éŒ„å–®'] || workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(targetSheet);
                    document.getElementById('analyzeBtn').disabled = false;
                    document.querySelector('.upload-area h3').textContent = `å·²ä¸Šå‚³ï¼š${file.name}`;
                    document.querySelector('.upload-area p').textContent = `å…±è®€å– ${excelData.length} ç­†è³‡æ–™`;
                    
                    // æ—¥æœŸé è™•ç†
                    excelData.forEach(row => {
                        const adjustDate = row['èª¿æ•´æ—¥æœŸ'];
                        if (adjustDate) {
                            try {
                                let dateStr = null;
                                if (typeof adjustDate === 'number') dateStr = excelDateToISOString(adjustDate);
                                else if (typeof adjustDate === 'string') {
                                    const rawStr = adjustDate.trim();
                                    let parts = rawStr.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
                                    if (parts) dateStr = `${parts[1]}-${String(parts[2]).padStart(2, '0')}-${String(parts[3]).padStart(2, '0')}`;
                                } else if (adjustDate instanceof Date) dateStr = adjustDate.toISOString().split('T')[0];
                                if(dateStr) row['FormattedDate'] = dateStr;
                            } catch(e){}
                        }
                    });
                    showDataPreview();
                } catch (error) { console.error(error); alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼ã€‚'); }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function showDataPreview() {
            if (excelData.length === 0) return;
            const actualFields = Object.keys(excelData[0]);
            let previewHtml = `<div class="preview-section"><h4>ğŸ“Š æ¬„ä½æª¢æ¸¬çµæœ</h4><div class="field-status">`;
            TARGET_FIELDS.forEach(field => {
                const exists = actualFields.includes(field);
                previewHtml += `<div class="field-item ${exists ? '' : 'missing'}"><div class="field-name">${field} ${exists ? 'âœ“' : 'âœ—'}</div></div>`;
            });
            previewHtml += `</div></div>`;
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection.querySelector('.preview-section')) uploadSection.querySelector('.preview-section').remove();
            uploadSection.insertAdjacentHTML('beforeend', previewHtml);
        }
        
        // --- åˆ†æé‚è¼¯ ---
        function filterDataByDate(data, startDate, endDate) {
            return data.filter(row => row['FormattedDate'] && row['FormattedDate'] >= startDate && row['FormattedDate'] <= endDate);
        }
        
        function analyzeData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate || excelData.length === 0) return;
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('dashboard').classList.remove('show');
            
            setTimeout(() => {
                try {
                    const filteredData = filterDataByDate(excelData, startDate, endDate);
                    if (filteredData.length === 0) {
                        alert('æ­¤æ—¥æœŸå€é–“ç„¡ç¬¦åˆè³‡æ–™'); document.getElementById('dashboard').classList.remove('show');
                    } else {
                        generateAnalysisReport(filteredData, startDate, endDate);
                        document.getElementById('dashboard').classList.add('show');
                    }
                } catch (error) { console.error(error); alert('åˆ†æéç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message); }
                finally { document.getElementById('loading').classList.remove('show'); }
            }, 100);
        }
        
        function generateAnalysisReport(data, startDate, endDate) {
            const rangeStr = `${startDate} ~ ${endDate}`;
            document.getElementById('dateRangeDisplay').textContent = `ä¸»è¦åˆ†æå€é–“ï¼š${rangeStr}`;
            document.getElementById('pdfDateDisplay').textContent = `çµ±è¨ˆå€é–“ï¼š${rangeStr}`;
            
            generateTrendCharts(excelData);
            const analysis = analyzeByFactoryAndDepartment(data);
            
            updateMoldingStats(analysis);
            updateAssemblyStats(analysis); 
            generateDetailedCharts(analysis);
            updateInsights(analysis, data);
        }
        
        // --- åœ–è¡¨ç”Ÿæˆ ---
        function generateTrendCharts(allData) {
            const trendBlock = document.getElementById('trendBlock');
            trendBlock.style.display = 'block';

            const startMonth = document.getElementById('trendStartMonth').value;
            const endMonth = document.getElementById('trendEndMonth').value;
            if(!startMonth || !endMonth) return;

            const monthlyStats = {};
            allData.forEach(row => {
                const date = row['FormattedDate'] || '';
                const monthKey = date.substring(0, 7); 
                if (!monthKey || monthKey < startMonth || monthKey > endMonth) return;
                
                if (!monthlyStats[monthKey]) monthlyStats[monthKey] = { total: 0, zongwei: 0, boss: 0 };
                monthlyStats[monthKey].total++;
                const factory = getFactory(row);
                if (factory === 'å®—ç‘‹å» ') monthlyStats[monthKey].zongwei++;
                if (factory === 'åšå£«å» ') monthlyStats[monthKey].boss++;
            });

            const labels = Object.keys(monthlyStats).sort();
            const zongweiData = labels.map(m => monthlyStats[m].zongwei);
            const bossData = labels.map(m => monthlyStats[m].boss);

            // ä¿®æ”¹ï¼šåŠ å¤§å­—é«” (åŸæœ¬ 14)
            const commonFont = { size: 24, weight: 'bold', family: "'Inter', sans-serif" };
            // ä¿®æ”¹ï¼šåŠ å¤§æ¨™é¡Œ (åŸæœ¬ 16)
            const titleFont = { size: 24, weight: 'bold' };
            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: { bottom: 25, top: 10 } },
                plugins: { 
                    legend: { position: 'top', labels: { font: commonFont, padding: 20 } },
                    tooltip: { mode: 'index', intersect: false, titleFont: { size: 20 }, bodyFont: { size: 20 } }
                },
                scales: { 
                    x: { ticks: { font: commonFont, maxRotation: 45, minRotation: 45 } },
                    y: { beginAtZero: true, ticks: { font: commonFont }, title: { display: true, text: 'ç¸½æ¡ˆä»¶æ•¸', font: titleFont } }
                }
            };

            if (charts['trendMain']) charts['trendMain'].destroy();
            charts['trendMain'] = new Chart(document.getElementById('trendMainChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'å®—ç‘‹å» ', data: zongweiData, borderColor: '#4A90E2', backgroundColor: '#4A90E2', tension: 0.4, fill: false, pointRadius: 6, borderWidth: 3 },
                        { label: 'åšå£«å» ', data: bossData, borderColor: '#E94B8C', backgroundColor: '#E94B8C', tension: 0.4, fill: false, pointRadius: 6, borderWidth: 3 }
                    ]
                },
                options: chartOptions
            });

            if (charts['trendVolume']) charts['trendVolume'].destroy();
            charts['trendVolume'] = new Chart(document.getElementById('trendVolumeChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'å®—ç‘‹å» ', data: zongweiData, backgroundColor: '#4A90E2', stack: 'combined' },
                        { label: 'åšå£«å» ', data: bossData, backgroundColor: '#E94B8C', stack: 'combined' }
                    ]
                },
                options: { 
                    ...chartOptions, 
                    plugins: { ...chartOptions.plugins, title: { display: false } },
                    scales: { y: { stacked: true, beginAtZero: true, ticks: { font: commonFont } }, x: { stacked: true, ticks: { font: commonFont, maxRotation: 45, minRotation: 45 } } } 
                }
            });
        }

        // --- çµ±è¨ˆè¨ˆç®— ---
        function analyzeByFactoryAndDepartment(data) {
            const result = { å®—ç‘‹å» : { æˆå‹: [], çµ„è£: [] }, åšå£«å» : { æˆå‹: [], çµ„è£: [] } };
            data.forEach(row => {
                const factory = getFactory(row);
                const department = getDepartment(row);
                if (factory && department && result[factory][department]) result[factory][department].push(row);
            });

            const stats = {};
            Object.keys(result).forEach(factory => {
                stats[factory] = {};
                Object.keys(result[factory]).forEach(dept => {
                    const deptData = result[factory][dept];
                    stats[factory][dept] = {
                        total: deptData.length,
                        dayShift: deptData.filter(row => getShift(row) === 'æ—¥' || getShift(row) === '').length,
                        nightShift: deptData.filter(row => getShift(row) === 'å¤œ').length,
                        issues: analyzeIssues(deptData),
                        personnel: analyzePersonnel(deptData),
                        detailedIssues: analyzeDetailedIssues(deptData, dept)
                    };
                });
            });
            return stats;
        }
        
        function getFactory(row) { const f = row['å» åˆ¥']?.toString(); return f?.includes('å®—ç‘‹') ? 'å®—ç‘‹å» ' : f?.includes('åšå£«') ? 'åšå£«å» ' : null; }
        function getDepartment(row) { const d = row['éƒ¨é–€']?.toString(); return d?.includes('æˆå‹') ? 'æˆå‹' : d?.includes('çµ„è£') ? 'çµ„è£' : null; }
        function getShift(row) { const s = row['ç­åˆ¥']?.toString(); return s?.includes('æ—¥') ? 'æ—¥' : s?.includes('å¤œ') ? 'å¤œ' : ''; }
        function analyzeIssues(data) { const i = {}; data.forEach(r => { const c = getReasonCategory(r); i[c] = (i[c] || 0) + 1; }); return i; }
        function analyzeDetailedIssues(data, dept) {
            const di = { day: { 'æ¼å ±å·¥': 0, 'æ•¸é‡éŒ¯èª¤': 0, 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)': 0, 'å…¶ä»–/æœªåˆ†é¡': 0 }, night: { 'æ¼å ±å·¥': 0, 'æ•¸é‡éŒ¯èª¤': 0, 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)': 0, 'å…¶ä»–/æœªåˆ†é¡': 0 } };
            data.forEach(r => { di[getShift(r) === 'å¤œ' ? 'night' : 'day'][getReasonCategory(r)]++; }); return di;
        }
        function getReasonCategory(row) {
            const s = row['èª¿æ•´åŸå› '] ? row['èª¿æ•´åŸå› '].toString() : '';
            return s.includes('æ¼å ±å·¥') ? 'æ¼å ±å·¥' : s.includes('æ•¸é‡éŒ¯èª¤') ? 'æ•¸é‡éŒ¯èª¤' : s.includes('æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)') ? 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)' : 'å…¶ä»–/æœªåˆ†é¡';
        }
        function analyzePersonnel(data) {
            const p = {};
            data.forEach(row => {
                const p1 = row['å ±å·¥äººå“¡1'];
                if (p1 && p1.toString().trim() !== '') {
                    p1.toString().split('/').forEach(n => { n = n.trim(); if(n) { if(!p[n]) p[n]={total:0}; p[n].total++; } });
                }
            });
            const r = {}; Object.keys(p).forEach(k => { if(p[k].total > 3) r[k] = { total: p[k].total }; });
            return r;
        }
        
        // --- è¦–åœ–æ›´æ–° ---
        function updateMoldingStats(analysis) {
            const zw = analysis['å®—ç‘‹å» ']['æˆå‹'], bs = analysis['åšå£«å» ']['æˆå‹'];
            const t = zw.total + bs.total;
            document.getElementById('zongweiMoldingTotal').textContent = `${zw.total} æ¬¡`;
            document.getElementById('zongweiMoldingDay').textContent = `${zw.dayShift} æ¬¡ (${t>0?((zw.dayShift/t)*100).toFixed(1):0}%)`;
            document.getElementById('zongweiMoldingNight').textContent = `${zw.nightShift} æ¬¡ (${t>0?((zw.nightShift/t)*100).toFixed(1):0}%)`;
            updateIssuesDisplay('zongweiMoldingIssues', zw.issues, zw.total);
            
            document.getElementById('bossMoldingTotal').textContent = `${bs.total} æ¬¡`;
            document.getElementById('bossMoldingDay').textContent = `${bs.dayShift} æ¬¡ (${t>0?((bs.dayShift/t)*100).toFixed(1):0}%)`;
            document.getElementById('bossMoldingNight').textContent = `${bs.nightShift} æ¬¡ (${t>0?((bs.nightShift/t)*100).toFixed(1):0}%)`;
            updateIssuesDisplay('bossMoldingIssues', bs.issues, bs.total);

            updatePersonnelDisplay('zongweiMoldingPersonnel', 'zongweiMoldingPersonnelTitle', zw.personnel, 'å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
            updatePersonnelDisplay('bossMoldingPersonnel', 'bossMoldingPersonnelTitle', bs.personnel, 'åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
        }

        function updateAssemblyStats(analysis) {
            const zw = analysis['å®—ç‘‹å» ']['çµ„è£'], bs = analysis['åšå£«å» ']['çµ„è£'];
            document.getElementById('zongweiAssemblyTotal').textContent = `${zw.total} æ¬¡`;
            document.getElementById('zongweiAssemblyDay').textContent = `${zw.dayShift} æ¬¡`;
            document.getElementById('zongweiAssemblyNight').textContent = `${zw.nightShift} æ¬¡`;
            updateIssuesDisplay('zongweiAssemblyIssues', zw.issues, zw.total);
            
            document.getElementById('bossAssemblyTotal').textContent = `${bs.total} æ¬¡`;
            document.getElementById('bossAssemblyDay').textContent = `${bs.dayShift} æ¬¡`;
            document.getElementById('bossAssemblyNight').textContent = `${bs.nightShift} æ¬¡`;
            updateIssuesDisplay('bossAssemblyIssues', bs.issues, bs.total);

            updatePersonnelDisplay('zongweiAssemblyPersonnel', 'zongweiAssemblyPersonnelTitle', zw.personnel, 'å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
            updatePersonnelDisplay('bossAssemblyPersonnel', 'bossAssemblyPersonnelTitle', bs.personnel, 'åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
        }
        
        function updateIssuesDisplay(id, issues, total) {
            const el = document.getElementById(id);
            if (total === 0) { el.innerHTML = '<div style="text-align:center;color:#28a745;padding:10px;">âœ… ç„¡ç•°å¸¸è¨˜éŒ„</div>'; return; }
            let html = '';
            Object.keys(issues).map(i => ({n:i, c:issues[i]})).sort((a,b)=>b.c-a.c).forEach(i => {
                html += `<div class="stats-row"><span class="stat-label">${i.n}</span><span class="stat-value">${i.c} æ¬¡ (${total>0?((i.c/total)*100).toFixed(1):0}%)</span></div>`;
            });
            el.innerHTML = html;
        }
        
        function updatePersonnelDisplay(id, tid, p, txt) {
            const el = document.getElementById(id);
            document.getElementById(tid).textContent = `${txt} (${Object.keys(p).length}ä½)`;
            if (Object.keys(p).length === 0) { el.innerHTML = '<div class="no-personnel">âœ… ç„¡äººå“¡ç™¼ç”Ÿæ¬¡æ•¸å¤§æ–¼3æ¬¡</div>'; return; }
            let html = '<div class="personnel-grid"><ul class="personnel-list">';
            Object.keys(p).map(n=>({n:n, c:p[n].total})).sort((a,b)=>b.c-a.c).forEach(i => {
                html += `<li class="personnel-item"><span class="personnel-name">${i.n}</span><span class="personnel-count">${i.c}æ¬¡</span></li>`;
            });
            el.innerHTML = html + '</ul></div>';
        }
        
        function generateDetailedCharts(analysis) {
            ['zongweiDetailed','bossDetailed'].forEach(k => { if(charts[k]) charts[k].destroy(); });
            const z = analysis['å®—ç‘‹å» ']['æˆå‹'].detailedIssues, b = analysis['åšå£«å» ']['æˆå‹'].detailedIssues, l = MAIN_ISSUES.slice(0, 3);
            let max = 0;
            l.forEach(i => max = Math.max(max, z.day[i], z.night[i], b.day[i], b.night[i]));
            const dispMax = max < 5 ? 5 : Math.ceil((max+1)/5)*5;
            const config = (d) => ({
                type: 'bar', data: { labels: l, datasets: [{label:'æ—¥ç­',data:l.map(i=>d.day[i]),backgroundColor:'rgba(75, 192, 192, 0.8)'},{label:'å¤œç­',data:l.map(i=>d.night[i]),backgroundColor:'rgba(255, 159, 64, 0.8)'}] },
                options: getDetailedChartOptions(dispMax)
            });
            charts['zongweiDetailed'] = new Chart(document.getElementById('zongweiMoldingDetailedChart').getContext('2d'), config(z));
            charts['bossDetailed'] = new Chart(document.getElementById('bossMoldingDetailedChart').getContext('2d'), config(b));
        }
        // ä¿®æ”¹ï¼šé€™å€‹å‡½å¼è™•ç†ç¬¬äºŒå¼µåœ–çš„è¨­å®šï¼ŒåŒ…å«åŠ å¤§é–“è·èˆ‡æ–‡å­—
        function getDetailedChartOptions(max) {
            return { 
                responsive: true, 
                maintainAspectRatio: false, 
                layout: { 
                    padding: { 
                        bottom: 50 // â˜… é—œéµï¼šåŠ å¤§åº•éƒ¨é–“è·ï¼Œé˜²æ­¢æ–‡å­—è¢«è£åˆ‡
                    } 
                }, 
                plugins: { 
                    legend: { 
                        position: 'top',
                        labels: {
                            font: {
                                size: 24, // â˜… é—œéµï¼šåŠ å¤§åœ–ä¾‹æ–‡å­—
                                weight: 'bold'
                            }
                        }
                    } 
                }, 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        max: max,
                        ticks: { font: { size: 14 } } 
                    }, 
                    x: { 
                        ticks: { 
                            font: { 
                                size: 16, // â˜… é—œéµï¼šåŠ å¤§ X è»¸æ–‡å­—
                                weight: 'bold' 
                            } 
                        } 
                    } 
                } 
            };
        }
        
        // --- æ´å¯Ÿå€å¡Š (ä¿®æ­£ç‰ˆï¼šAI é‚è¼¯æ›´æ–°) ---
        function updateInsights(analysis, rawData) {
            const total = Object.values(analysis).reduce((s, f) => s + Object.values(f).reduce((ds, d) => ds + d.total, 0), 0);
            const allIssues = {}; 
            Object.values(analysis).forEach(f => Object.values(f).forEach(d => Object.keys(d.issues).forEach(i => allIssues[i] = (allIssues[i]||0) + d.issues[i])));
            
            // 1. ä¸€èˆ¬è§€å¯Ÿèˆ‡çµè«– (æ”¾é€² insightsGrid)
            const standardInsights = [
                { title: "ğŸ“Š æˆå‹ç­åˆ¥èˆ‡ç¸½é«”ç¾æ³", fn: generateMergedShiftTrendAnalysis }, 
                { title: "âš ï¸ ä¸»è¦å•é¡Œèˆ‡äººå“¡åˆ†æ", fn: generateMergedIssuePersonnelAnalysis },
                { title: "ğŸ’¡ çµè«–èˆ‡æµç¨‹æ”¹å–„æ–¹å‘", fn: generateEditableRecommendations, spanFull: true }
            ];
            
            let html = '';
            standardInsights.forEach(insight => { 
                const res = insight.fn(analysis, total, allIssues);
                let content = res.isMerged ? res.htmlContent : (res.isStructured ? `<p><b>${res.summary}</b></p><ul>${res.list.map(i => `<li>${i.title}ï¼š ${i.content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</li>`).join('')}</ul>` : `<p>${res.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>`);
                html += `<div class="insight-item${insight.spanFull?' span-full':''}"${insight.id?` id="${insight.id}"`:''}><h4>${insight.title}</h4><div class="insight-content-box">${content}</div></div>`;
            });
            document.getElementById('insightsGrid').innerHTML = html;

            // 2. AI å»ºè­° (åˆ¤æ–·æ˜¯å¦æœ‰ Key)
            const apiKey = document.getElementById('apiKey').value.trim();
            const aiBlock = document.getElementById('aiBlock');
            const aiContent = document.getElementById('aiContent');

            if (!apiKey) {
                // å¦‚æœæ²’æœ‰ Keyï¼Œéš±è—å€å¡Š
                aiBlock.style.display = 'none';
            } else {
                // æœ‰ Keyï¼Œé¡¯ç¤ºå€å¡Šä¸¦å‘¼å« API
                aiBlock.style.display = 'block';
                callGeminiFlash(apiKey, analysis, total, allIssues);
            }
        }

        // æ–°å¢ï¼šå‘¼å« Gemini API (ä¿®æ­£ç´…æ¡†å•é¡Œèˆ‡æ©Ÿå™¨èªæ°£ï¼Œä¸¦é è¨­æ”¹ç”¨ 2.5-flash)
        async function callGeminiFlash(apiKey, analysis, total, allIssues) {
            const aiContent = document.getElementById('aiContent');
            aiContent.innerHTML = '<p>ğŸ¤– æ­£åœ¨é€£ç·š Gemini é€²è¡Œåˆ†æ...</p>';

            // å»ºæ§‹ Prompt
            const zwMolding = analysis['å®—ç‘‹å» ']['æˆå‹'];
            const bsMolding = analysis['åšå£«å» ']['æˆå‹'];
            const zwAssy = analysis['å®—ç‘‹å» ']['çµ„è£'];
            const bsAssy = analysis['åšå£«å» ']['çµ„è£'];

            const promptText = `
            ä½ æ˜¯ä¸€ä½è¬›æ±‚æ•ˆç‡çš„ç¾å ´æ”¹å–„å°ˆå®¶ã€‚é‡å°å·¥å»  MES å ±å·¥ç•°å¸¸ (${total}ç­†)ï¼Œè«‹çµ¦å‡º 3 é»ã€Œæ¥µç°¡ã€ç„¡å»¢è©±ã€çš„åŸ·è¡Œå‹•ä½œã€‚
            
            ã€é™åˆ¶æ¢ä»¶ã€‘
            1. **çµ•ä¸æ‡²ç½°**ï¼šåš´ç¦æåˆ°æ‰£éŒ¢ã€è¨˜éã€‚
            2. **å­—æ•¸é™åˆ¶**ï¼šæ¯é»å»ºè­° **åš´æ ¼é™åˆ¶åœ¨ 30 å­—ä»¥å…§**ã€‚
            3. **ç¦æ­¢è§£é‡‹**ï¼šä¸è¦å¯«ã€Œç‚ºäº†...ã€ã€ã€Œå› ç‚º...ã€ï¼Œç›´æ¥å¯«ã€Œåšä»€éº¼ã€ã€‚
            4. **èªæ°£**ï¼šä¸­æ€§ã€æŒ‡ä»¤å¼ã€çŸ­ä¿ƒã€‚
        
            ã€æ•¸æ“šåƒè€ƒã€‘
            - ç•°å¸¸é¡å‹ï¼š${JSON.stringify(allIssues)}
            - ç•°å¸¸åˆ†ä½ˆï¼šå®—ç‘‹å»  ${zwMolding.total} / åšå£«å»  ${bsMolding.total}
        
            ã€è¼¸å‡ºæ ¼å¼ HTMLã€‘
            <ul>
              <li><b>[å‹•ä½œæ¨™é¡Œ]</b>: [å‹•ä½œå…§å®¹ (é™30å­—)]</li>
              <li><b>[å‹•ä½œæ¨™é¡Œ]</b>: [å‹•ä½œå…§å®¹ (é™30å­—)]</li>
              <li><b>[å‹•ä½œæ¨™é¡Œ]</b>: [å‹•ä½œå…§å®¹ (é™30å­—)]</li>
            </ul>
        `;
            // è¨­å®šé è¨­æ¨¡å‹ (gemini-2.5-flash)
            let modelName = 'gemini-2.5-flash'; 
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API å›å‚³éŒ¯èª¤ (${response.status})ã€‚è«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºï¼Œæˆ–å˜—è©¦æ›´æ›æ¨¡å‹åç¨±ã€‚`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    let aiText = data.candidates[0].content.parts[0].text;
                    
                    // é—œéµä¿®æ­£ï¼šå¼·åˆ¶ç§»é™¤æ‰€æœ‰å¯èƒ½æ®˜ç•™çš„ Markdown ä»£ç¢¼å€å¡Šç¬¦è™Ÿ
                    aiText = aiText.replace(/^```html\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '').trim();

                    // ç›´æ¥ä½¿ç”¨ innerHTML å‘ˆç¾ HTMLï¼Œä¸ç¶“é marked è§£æï¼Œé¿å…é¡¯ç¤ºåŸå§‹ç¢¼
                    aiContent.innerHTML = `<div class="insight-content-box">${aiText}</div>`;
                } else {
                    aiContent.innerHTML = '<p style="color:red;">API å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºã€‚</p>';
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                aiContent.innerHTML = `<p style="color:red;">é€£ç·šå¤±æ•—ï¼š${error.message}</p>`;
            }
        }

        function generateMergedShiftTrendAnalysis(a, t, all) {
            const zw = a['å®—ç‘‹å» ']['æˆå‹'], bs = a['åšå£«å» ']['æˆå‹'], mt = zw.total + bs.total;
            let res = `**å®—ç‘‹å» ** æˆå‹éƒ¨é–€ä½”æˆå‹ç¸½ç•°å¸¸ **${mt>0?((zw.total/mt)*100).toFixed(1):0}%**ï¼Œ**åšå£«å» ** ä½” **${mt>0?((bs.total/mt)*100).toFixed(1):0}%**ã€‚`;
            const c = [{f:'å®—ç‘‹',s:'å¤œç­',c:zw.nightShift},{f:'å®—ç‘‹',s:'æ—¥ç­',c:zw.dayShift},{f:'åšå£«',s:'å¤œç­',c:bs.nightShift},{f:'åšå£«',s:'æ—¥ç­',c:bs.dayShift}].sort((x,y)=>y.c-x.c);
            if(c[0].c > 0) res += `<br>çµè«–ï¼š**${c[0].f}å» ** çš„ **${c[0].s}** ç•°å¸¸é »ç‡æœ€é«˜ã€‚`;
            const zwT = a['å®—ç‘‹å» ']['æˆå‹'].total + a['å®—ç‘‹å» ']['çµ„è£'].total, bsT = a['åšå£«å» ']['æˆå‹'].total + a['åšå£«å» ']['çµ„è£'].total;
            return { htmlContent: `<p>${res.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p><hr style="margin: 15px 0; border-top: 2px solid #e0e7ff;"><p>å…©å» ç•°å¸¸ç¸½æ•¸ï¼šå®—ç‘‹å»  <b>${zwT} æ¬¡</b>ï¼Œåšå£«å»  <b>${bsT} æ¬¡</b>ã€‚</p>`, isMerged: true };
        }
        function generateMergedIssuePersonnelAnalysis(a, t, all) {
            const l = all['æ¼å ±å·¥']||0, q = all['æ•¸é‡éŒ¯èª¤']||0;
            let cnt = 0; Object.values(a).forEach(f => Object.values(f).forEach(d => cnt += Object.keys(d.personnel).length));
            return { htmlContent: `<p>æœ¬æœŸç¸½ç•°å¸¸ <b>${t}</b> æ¬¡ï¼š<b>æ¼å ±å·¥</b> (${t>0?((l/t)*100).toFixed(1):0}%)ã€<b>æ•¸é‡éŒ¯èª¤</b> (${t>0?((q/t)*100).toFixed(1):0}%)ã€‚</p><hr style="margin: 15px 0; border-top: 2px solid #e0e7ff;"><p>${cnt > 0 ?
            `æœ¬æœŸå…±è¨ˆ <b>${cnt}</b> ä½äººå“¡ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡ï¼Œæ‡‰åŠ å¼·æ“ä½œæŒ‡å°ã€‚` : "äººå“¡å ±å·¥è¡¨ç¾ç©©å®šã€‚"}</p>`, isMerged: true };
        }
        
        function generateEditableRecommendations(a, t) {
            const defaultContent = `<div>1. SOP åŸ·è¡Œç¢ºèªï¼šä¸»ç®¡æ‡‰é‡å°ç•°å¸¸äººå“¡é€²è¡Œç¾å ´æŸ¥æ ¸æˆ–è¨“ç·´ã€‚</div>
                                    <div>2. å³æ™‚å›å ±ï¼šç³»çµ±ä½¿ç”¨ä¸Šæœ‰å•é¡Œæ‡‰ç¬¬ä¸€æ™‚é–“é€šçŸ¥ï¼Œé¿å…æµç¨‹éŒ¯èª¤ã€‚</div>
                                    <div>3. æ•¸é‡æ ¸å°ï¼šè½å¯¦æ¯æ—¥ç”Ÿç”¢æ•¸èˆ‡å¯¦éš›å ±å·¥æ•¸ä¹‹æ¯”å°æµç¨‹ã€‚</div>`;
            return { 
                isMerged: true, 
                htmlContent: `<div class="editable-advice-box" contenteditable="true" placeholder="é»æ“Šæ­¤è™•è¼¸å…¥æ‚¨çš„è§€å¯Ÿçµè«–èˆ‡å»ºè­°æ”¹å–„æ–¹å‘...">${defaultContent}</div>`
            };
        }
        
        // èˆŠæœ‰çš„æœ¬åœ°é‚è¼¯ (ä¿ç•™ä½†ç¾åœ¨å·²ä¸è¢«å‘¼å«ï¼Œå› ç‚ºæœƒè¢« API å–ä»£æˆ–éš±è—)
        function generateAIConsultantAdvice(analysis, total, allIssues) {
            return { summary: "è³‡æ·±æ•¸æ“šé¡§å•ç­–ç•¥è§€é» (åŸºæ–¼æœ¬æœŸæ•¸æ“š)ï¼š", isStructured: true, list: [] };
        }

        // --- PDF åŒ¯å‡ºé‚è¼¯ (ä¿®æ­£è£åˆ‡å•é¡Œèˆ‡æ²å‹•å•é¡Œ) ---
        async function exportSelectedPdf() {
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                alert('âš ï¸ éŒ¯èª¤ï¼šPDF æ ¸å¿ƒå…ƒä»¶æœªè¼‰å…¥ã€‚\n\nè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šï¼Œæˆ–ç¢ºèªé˜²ç«ç‰†æ˜¯å¦é˜»æ“‹äº† cdnjs.cloudflare.comã€‚');
                return;
            }

            const items = document.querySelectorAll('.sortable-item');
            let renderQueue = [];
            const header = document.getElementById('pdfTitleHeader'), range = document.getElementById('dateRangeDisplay'), controls = document.querySelector('.trend-controls');
            const footer = document.getElementById('reportFooter');

            renderQueue.push({ element: header });
            renderQueue.push({ element: range });
            items.forEach(i => { 
                const chk = i.querySelector('input');
                const id = i.getAttribute('data-id');
                const el = document.getElementById(id);
                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ä¸”å¯è¦‹ (é¿å…åŒ¯å‡ºéš±è—çš„ AI å€å¡Š)
                if(chk.checked && el && el.style.display !== 'none') renderQueue.push({ element: el }); 
            });
            
            if(footer) renderQueue.push({ element: footer });

            if (renderQueue.length <= 2) { alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹åŒ¯å‡ºé …ç›®'); return; }

            const exportModal = document.getElementById('exportModal');
            exportModal.style.display = 'none'; 
            document.getElementById('loading').classList.add('show');
            
            header.style.display = 'block';
            if(controls) controls.style.display = 'none'; 
            
            // 1. è¨˜éŒ„ç›®å‰æ²å‹•ä½ç½®
            const originalScrollPos = window.scrollY;
            // 2. å¼·åˆ¶æ²åˆ°æœ€ä¸Šæ–¹ (ç‚ºäº†ç¢ºä¿ html2canvas æˆªåœ–å®Œæ•´)
            window.scrollTo(0, 0);

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const W = pdf.internal.pageSize.getWidth(), H = pdf.internal.pageSize.getHeight(), m = 5, cW = W - m*2, cH = H - m*2;
            let cY = m;

            try {
                for (let item of renderQueue) {
                    if(!item.element) continue;
                    const c = await html2canvas(item.element, { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        backgroundColor: "#ffffff", 
                        windowWidth: 1600,
                        scrollY: 0 // å› ç‚ºå·²ç¶“æ²åˆ°æœ€ä¸Šæ–¹ï¼Œé€™è£¡è¨­ç‚º 0 å³å¯ï¼Œé¿å…è¨ˆç®—éŒ¯èª¤
                    });
                    const rH = (c.height * cW) / c.width;
                    
                    if (cY + rH > cH - 10) { 
                        pdf.addPage(); 
                        cY = m; 
                    }
                    
                    pdf.addImage(c.toDataURL('image/jpeg', 0.95), 'JPEG', m, cY, cW, rH);
                    cY += rH + 5;
                }
                pdf.save(`MESå ±å·¥åˆ†æ_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`);
            } catch (e) { 
                console.error(e);
                alert('åŒ¯å‡º PDF æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + e.message); 
            } finally { 
                header.style.display = 'none';
                if(controls) controls.style.display = 'flex'; 
                document.getElementById('loading').classList.remove('show');
                // 3. æ¢å¾©åŸæœ¬çš„æ²å‹•ä½ç½®
                window.scrollTo(0, originalScrollPos);
            }
        }
        
        window.moveUp = function(btn) { const i=btn.closest('.sortable-item'), p=i.previousElementSibling; if(p) i.parentNode.insertBefore(i, p); };
        window.moveDown = function(btn) { const i=btn.closest('.sortable-item'), n=i.nextElementSibling; if(n) i.parentNode.insertBefore(n, i); };
        
        window.onload = () => { setDefaultDates(); setupListeners(); };
    </script>
</body>
</html>
