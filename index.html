<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå¹³å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼å’ŒéŸ¿æ‡‰å¼è¨­è¨ˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 10vh;
            padding: 20px;
            font-size: 1.0rem; /* 16px */
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 30px; 
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem; 
            margin-bottom: 15px;
            font-weight: 800;
        }

        .header p {
            font-size: 1.1rem; 
        }
        
        .upload-section {
            padding: 35px; 
            border-bottom: 2px solid #f0f0f0;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px; 
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area h3 {
            font-size: 1.4rem; 
        }
        
        .upload-area p {
            font-size: 1rem; 
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #5a6fd8;
        }
        
        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #4A5FC7;
        }
        
        .upload-icon {
            font-size: 3rem; 
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .path-input-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .path-input-section h4 {
            font-size: 1.1rem;
        }

        .path-input {
            width: 100%;
            padding: 12px; 
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem; 
            margin-top: 15px;
        }
        
        .date-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-top: 25px;
            flex-wrap: wrap;
            font-size: 1rem;
        }
        
        .date-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-input {
            padding: 10px 15px; 
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem; 
            transition: border-color 0.3s;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px; 
            border-radius: 30px;
            font-size: 1rem; 
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
        }
        
        .analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .dashboard {
            padding: 35px 30px; 
            display: none;
        }
        
        .dashboard.show {
            display: block;
        }
        
        .date-range-display {
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px; 
            border-radius: 12px;
            margin-bottom: 30px;
            font-size: 2.2rem; 
            font-weight: 700;
            color: #333;
        }
        
        .factory-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px; 
            margin-bottom: 30px; 
        }
        
        .section-subtitle {
            font-size: 2.6rem; 
            font-weight: 700;
            color: #333;
            margin-bottom: 22px;
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 16px;
            border-radius: 15px;
        }
        
        .factory-card {
            background: white;
            border-radius: 16px;
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: transform 0.3s ease;
        }
        
        .factory-card:hover {
            transform: translateY(-5px);
        }
        
        .factory-title {
            /* ä¿®æ­£ 4: å†æ¬¡æ”¾å¤§å­—é«” */
            font-size: 1.8rem; 
            font-weight: 700;
            /* ä¿®æ­£ 4: å£“ç¸®é‚Šè·ä»¥æ›å–ç©ºé–“ */
            margin-bottom: 15px;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            color: white;
        }
        
        .molding-title {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
        }
        
        .assembly-title {
            background: linear-gradient(135deg, #E94B8C, #D63384);
        }
        
        .stats-section {
            margin-bottom: 15px;
        }
        
        .stats-group-title {
            /* ä¿®æ­£ 4: å†æ¬¡æ”¾å¤§å­—é«” */
            font-size: 1.4rem; 
            font-weight: 600;
            color: #4A90E2;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 3px solid #E3F2FD;
            /* FIX 1: å‚ç›´ç½®ä¸­ (é€é padding/margin) ä¸¦ç½®å·¦ */
            text-align: left; /* <-- CHANGED for left alignment */
            padding-left: 10px; /* New: Add some left padding */
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 4px 0; 
        }
        
        .stat-label, .stat-value {
            font-size: 1.3rem; 
        }

        .stat-label {
            color: #444;
            font-weight: 500;
        }
        
        .stat-value {
            font-weight: 700;
            color: #333;
        }
        
        /* è©³ç´°åœ–è¡¨æ¨£å¼ */
        .detailed-chart-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            /* ä¿®æ­£ 4: å£“ç¸®ç©ºé–“ */
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .detailed-chart-container {
            height: 380px; 
            padding: 15px;
            background: #f8f9ff;
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .detailed-chart-title {
            text-align: center;
            font-size: 1.4rem; 
            font-weight: 700;
            color: #4A90E2;
            margin-bottom: 15px;
        }

        /* å…¨å¯¬äººå“¡åå–®æ¨£å¼ */
        .full-width-personnel-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            /* ä¿®æ­£ 4: å£“ç¸®ç©ºé–“ */
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .personnel-section {
            /* ä¿®æ­£ 4: å£“ç¸®ç©ºé–“ */
            padding: 12px;
            background: #f8f9ff;
            border-radius: 15px;
            border-left: 5px solid #4A90E2;
        }
        
        .personnel-title {
            font-size: 1.4rem; 
            font-weight: 700;
            color: #4A90E2;
            margin-bottom: 12px;
            /* ä¿®æ­£ 4: æ°´å¹³ç½®ä¸­ */
            text-align: center;
        }
        
        .personnel-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .personnel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .personnel-item {
            background: white;
            padding: 8px 15px; 
            margin-bottom: 5px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            border-left: 4px solid #E94B8C;
            font-size: 1.25rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .personnel-name {
            font-weight: 600;
            color: #333;
        }
        
        .personnel-count {
            font-weight: 700;
            color: #E94B8C;
        }
        
        .no-personnel {
            color: #28a745;
            font-style: italic;
            text-align: center;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .insights {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            margin-top: 30px;
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            /* ä¿®æ­£ 4: å£“ç¸®ç©ºé–“ */
            gap: 20px;
        }
        
        .insight-item {
            background: #f8f9ff;
            border-left: 5px solid #667eea; 
            /* ä¿®æ­£ 4: å£“ç¸®ç©ºé–“ */
            padding: 15px;
            border-radius: 10px;
        }
        
        .insight-item h4 {
            color: #667eea;
            /* ä¿®æ­£ 4: å£“ç¸®ç©ºé–“ */
            margin-bottom: 12px;
            /* ä¿®æ­£ 4: å†æ¬¡æ”¾å¤§å­—é«” */
            font-size: 1.5rem; 
            font-weight: 700;
            /* FIX 1: å‚ç›´ç½®ä¸­ (é€é padding/margin) ä¸¦ç½®å·¦ */
            text-align: left; /* <-- CHANGED for left alignment */
        }
        
        /* Insights Formatting */
        .insight-content-box {
            margin-top: 10px;
            padding: 12px 15px; 
            border-radius: 8px;
            background-color: white; 
            border: 1px solid #e0e7ff;
        }
        
        .insight-content-box strong, .insight-content-box b {
            display: inline;
            color: #764ba2; 
            font-weight: 800;
        }
        
        .insight-content-box p,
        .insight-content-box li {
            color: #333;
            line-height: 1.6; 
            font-size: 1.28rem; 
            margin-bottom: 8px;
            text-align: justify;
        }
        
        /* FIX 4: èª¿æ•´åˆ—è¡¨æ¨£å¼ï¼Œä½¿ç”¨ç®­é ­ç¬¦è™Ÿä»£æ›¿ç·¨è™Ÿï¼Œé¿å… PDF åŒ¯å‡ºæ™‚å‡ºç¾ 1.1.1. çš„éŒ¯èª¤ */
        .insight-content-box ul {
            list-style-type: none;
            padding-left: 0;
            margin-left: 0;
            margin-top: 10px;
        }
        .insight-content-box li {
            margin-bottom: 8px;
            padding-left: 25px; 
            text-indent: -20px;
        }
        .insight-content-box li::before {
            content: "â”"; /* ä½¿ç”¨ç°¡å–®çš„ç®­é ­ç¬¦è™Ÿ */
            font-weight: bold;
            color: #E94B8C; /* ä½¿ç”¨çªå‡ºçš„é¡è‰² */
            margin-right: 10px;
            font-size: 1.1rem;
        }
        /* End of Insights Formatting */

        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            font-size: 1.4rem;
            color: #667eea;
            font-weight: 600;
        }
        
        .loading.show {
            display: block;
        }

        .preview-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            font-size: 1rem;
        }
        
        .field-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px;
            margin-top: 15px;
        }
        
        .field-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95rem;
            border-left: 4px solid #28a745;
        }
        
        .field-item.missing {
            border-left-color: #dc3545;
        }
        
        .field-name {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .field-value {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* æ¡Œé¢ä½ˆå±€èª¿æ•´ */
        @media (min-width: 1024px) {
            .insight-grid {
                grid-template-columns: 1fr 1fr; 
            }
            .insight-item.span-full {
                grid-column: 1 / 3; /* Spans both 2 columns */
            }
        }
        
        /* è¡Œå‹•è£ç½®éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .factory-row,
            .detailed-chart-section,
            .full-width-personnel-section {
                grid-template-columns: 1fr;
            }
            .personnel-grid {
                grid-template-columns: 1fr;
            }
            .insight-grid {
                grid-template-columns: 1fr;
            }
            .date-selector {
                flex-direction: column;
                gap: 15px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .section-subtitle {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå¹³å°</h1>
            <p>è£½é€ åŸ·è¡Œç³»çµ± Â· ç¾å ´å ±å·¥æ•¸æ“šåˆ†æ Â· æ™ºèƒ½ç•°å¸¸æª¢æ¸¬--Crafted by Alanå‹å…¨</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h3>ä¸Šå‚³Excelæª”æ¡ˆæˆ–æ‹–æ‹½è‡³æ­¤</h3>
                <p>æ”¯æ´ .xlsx, .xls æ ¼å¼ï¼Œå°‡è‡ªå‹•è®€å–ã€Œç´€éŒ„å–®ã€å·¥ä½œè¡¨</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="path-input-section">
                <h4>æˆ–è¼¸å…¥å…§ç¶²æª”æ¡ˆè·¯å¾‘</h4>
                <input type="text" id="pathInput" class="path-input" 
                       placeholder="ä¾‹å¦‚ï¼š\\server\shared\MESå ±å·¥æ•¸æ“šä¿®æ­£æ˜ç´°.xlsx" 
                       disabled>
                <small>æ³¨æ„ï¼šå…§ç¶²è·¯å¾‘åŠŸèƒ½éœ€è¦åœ¨å…§ç¶²ç’°å¢ƒä¸­ä½¿ç”¨</small>
            </div>
            
            <div class="date-selector">
                <div class="date-group">
                    <label for="startDate">çµ±è¨ˆèµ·å§‹æ—¥ï¼š</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <div class="date-group">
                    <label for="endDate">çµ±è¨ˆçµæŸæ—¥ï¼š</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
                <button id="analyzeBtn" class="analyze-btn" disabled>é–‹å§‹åˆ†æ</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div>ğŸ”„ æ­£åœ¨åˆ†ææ•¸æ“šä¸­...</div>
        </div>
        
        <div class="dashboard" id="dashboard">
            <div style="text-align: right; margin-bottom: 20px;">
                <button id="exportPdfBtn" class="analyze-btn">åŒ¯å‡ºå ±è¡¨ç‚ºPDF</button>
            </div>
            
            <!-- FIX 2: æ–°å¢ä¸€å€‹ wrapper ä¾†æ§åˆ¶ PDF åŒ¯å‡ºæ™‚çš„ DOM æ•ç²ç¯„åœï¼Œé¿å…æ’ç‰ˆéŒ¯ä½ -->
            <div id="pdfContentWrapper">
                <!-- ä¿®æ­£ 2: æ”¾å¤§ PDF æ¨™é¡Œå­—é«” -->
                <div id="pdfTitle" style="display:none; text-align:center; font-size: 40px; font-weight: bold; margin-bottom: 20px;">
                    MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æ
                </div>
                <div class="date-range-display" id="dateRangeDisplay"></div>
                
                <!-- æˆå‹éƒ¨é–€ -->
                <div id="moldingSection">
                    <div class="section-subtitle">ğŸ”§ æˆå‹éƒ¨é–€ç¾æ³</div>
                    <!-- åŸºç¤çµ±è¨ˆå¡ç‰‡ -->
                    <div class="factory-row">
                        <div class="factory-card">
                            <div class="factory-title molding-title">å®—ç‘‹å»  - æˆå‹éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š ç­åˆ¥çµ±è¨ˆ (ä½”å…©å» ç¸½ç•°å¸¸ç™¾åˆ†æ¯”)</div>
                                <div class="stats-row">
                                    <span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span>
                                    <span class="stat-value" id="zongweiMoldingTotal">0 æ¬¡</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">æ—¥ç­ç™¼ç”Ÿæ¬¡æ•¸</span>
                                    <span class="stat-value" id="zongweiMoldingDay">0 æ¬¡ (0%)</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">å¤œç­ç™¼ç”Ÿæ¬¡æ•¸</span>
                                    <span class="stat-value" id="zongweiMoldingNight">0 æ¬¡ (0%)</span>
                                </div>
                            </div>
                            <div class="stats-section">
                                <div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div>
                                <div id="zongweiMoldingIssues"></div>
                            </div>
                        </div>
                        
                        <div class="factory-card">
                            <div class="factory-title molding-title">åšå£«å»  - æˆå‹éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š ç­åˆ¥çµ±è¨ˆ (ä½”å…©å» ç¸½ç•°å¸¸ç™¾åˆ†æ¯”)</div>
                                <div class="stats-row">
                                    <span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span>
                                    <span class="stat-value" id="bossMoldingTotal">0 æ¬¡</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">æ—¥ç­ç™¼ç”Ÿæ¬¡æ•¸</span>
                                    <span class="stat-value" id="bossMoldingDay">0 æ¬¡ (0%)</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">å¤œç­ç™¼ç”Ÿæ¬¡æ•¸</span>
                                    <span class="stat-value" id="bossMoldingNight">0 æ¬¡ (0%)</span>
                                </div>
                            </div>
                            <div class="stats-section">
                                <div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div>
                                <div id="bossMoldingIssues"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°åœ–è¡¨å€å¡Š -->
                    <div class="detailed-chart-section">
                        <div class="detailed-chart-container">
                            <div class="detailed-chart-title">å®—ç‘‹å»  - ç­åˆ¥èˆ‡å•é¡Œåˆ†æ (æˆå‹)</div>
                            <canvas id="zongweiMoldingDetailedChart"></canvas>
                        </div>
                        <div class="detailed-chart-container">
                            <div class="detailed-chart-title">åšå£«å»  - ç­åˆ¥èˆ‡å•é¡Œåˆ†æ (æˆå‹)</div>
                            <canvas id="bossMoldingDetailedChart"></canvas>
                        </div>
                    </div>

                    <!-- äººå“¡åå–®å€å¡Š (æˆå‹) -->
                    <div class="full-width-personnel-section">
                        <div class="personnel-section">
                            <div class="personnel-title" id="zongweiMoldingPersonnelTitle">å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="zongweiMoldingPersonnel"></div>
                        </div>
                        <div class="personnel-section">
                            <div class="personnel-title" id="bossMoldingPersonnelTitle">åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="bossMoldingPersonnel"></div>
                        </div>
                    </div>
                </div>
                
                <!-- çµ„è£éƒ¨é–€ -->
                <div id="assemblySection">
                    <div class="section-subtitle">ğŸ“¦ çµ„è£éƒ¨é–€ç¾æ³</div>
                    <div class="factory-row">
                        <div class="factory-card">
                            <div class="factory-title assembly-title">å®—ç‘‹å»  - çµ„è£éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š åŸºæœ¬çµ±è¨ˆ</div>
                                <div class="stats-row">
                                    <span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span>
                                    <span class="stat-value" id="zongweiAssemblyTotal">0 æ¬¡</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">å·¥ä½œç­åˆ¥</span>
                                    <span class="stat-value">æ—¥ç­ä½œæ¥­</span>
                                </div>
                            </div>
                            <div class="stats-section">
                                <div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div>
                                <div id="zongweiAssemblyIssues"></div>
                            </div>
                        </div>
                        
                        <div class="factory-card">
                            <div class="factory-title assembly-title">åšå£«å»  - çµ„è£éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š åŸºæœ¬çµ±è¨ˆ</div>
                                <div class="stats-row">
                                    <span class="stat-label">å ±å·¥ä¿®æ­£ç¸½æ¬¡æ•¸</span>
                                    <span class="stat-value" id="bossAssemblyTotal">0 æ¬¡</span>
                                </div>
                                <div class="stats-row">
                                    <span class="stat-label">å·¥ä½œç­åˆ¥</span>
                                    <span class="stat-value">æ—¥ç­ä½œæ¥­</span>
                                </div>
                            </div>
                            <div class="stats-section">
                                <div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div>
                                <div id="bossAssemblyIssues"></div>
                            </div>
                        </div>
                    </div>

                    <!-- äººå“¡åå–®å€å¡Š (çµ„è£) -->
                    <div class="full-width-personnel-section">
                        <div class="personnel-section">
                            <div class="personnel-title" id="zongweiAssemblyPersonnelTitle">å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="zongweiAssemblyPersonnel"></div>
                        </div>
                        <div class="personnel-section">
                            <div class="personnel-title" id="bossAssemblyPersonnelTitle">åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡</div>
                            <div id="bossAssemblyPersonnel"></div>
                        </div>
                    </div>
                </div>
                
                <div class="insights" id="insightsSection">
                    <div class="section-subtitle">ğŸ“Š å®¢è§€ç¾æ³è§€å¯Ÿèˆ‡å»ºè­°</div>
                    <div class="insight-grid" id="insightsGrid">
                        <!-- Insights will be generated here -->
                    </div>
                </div>
            </div>
            <!-- END OF pdfContentWrapper -->
        </div>
    </div>
    
    <script>
        let excelData = [];
        let charts = {};
        
        const TARGET_FIELDS = ['å» åˆ¥', 'éƒ¨é–€', 'èª¿æ•´æ—¥æœŸ', 'å ±å·¥äººå“¡1', 'ç­åˆ¥', 'èª¿æ•´åŸå› '];
        // å®šç¾©ä¸»è¦å•é¡Œé¡å‹
        const MAIN_ISSUES = ['æ¼å ±å·¥', 'æ•¸é‡éŒ¯èª¤', 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)', 'å…¶ä»–/æœªåˆ†é¡'];
        
        // Helper: å°‡ Excel åºåˆ—æ—¥æœŸ (æ•¸å­—) è½‰æ›ç‚º YYYY-MM-DD å­—ç¬¦ä¸²
        function excelDateToISOString(serial) {
            if (typeof serial !== 'number' || isNaN(serial) || serial <= 0) {
                return null;
            }
            const baseDate = new Date(Date.UTC(1899, 11, 30));
            const date = new Date(baseDate.getTime() + (serial * 24 * 60 * 60 * 1000));
            if (isNaN(date.getTime())) {
                return null; 
            }
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // è¨­ç½®é è¨­æ—¥æœŸ (ä¸Šä¸€å€‹å®Œæ•´çš„æ—¥æ›†æœˆ)
        function setDefaultDates() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            const startDateObj = new Date(currentYear, currentMonth - 1, 1);
            const endDateObj = new Date(currentYear, currentMonth, 0); 
            const formatDate = (date) => date.toISOString().split('T')[0];
            document.getElementById('startDate').value = formatDate(startDateObj);
            document.getElementById('endDate').value = formatDate(endDateObj);
        }
        
        // æª”æ¡ˆä¸Šå‚³è™•ç†
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => {
                // FIX: ä¿®æ­£å­˜å–æª”æ¡ˆåˆ—è¡¨çš„éŒ¯èª¤ï¼Œæ‡‰ç‚º e.target.files
                if (e.target.files && e.target.files.length > 0) handleFile(e.target.files[0]);
            });
            analyzeBtn.addEventListener('click', analyzeData);
        }
        
        // è™•ç†ä¸Šå‚³çš„æª”æ¡ˆ
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('è«‹ä¸Šå‚³Excelæª”æ¡ˆï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: false}); 
                    let targetSheet = workbook.Sheets['ç´€éŒ„å–®'] || workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(targetSheet);
                    document.getElementById('analyzeBtn').disabled = false;
                    document.querySelector('.upload-area h3').textContent = `å·²ä¸Šå‚³ï¼š${file.name}`;
                    document.querySelector('.upload-area p').textContent = `å…±è®€å– ${excelData.length} ç­†è³‡æ–™`;
                    showDataPreview();
                } catch (error) {
                    console.error('æª”æ¡ˆè®€å–éŒ¯èª¤:', error);
                    alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // é¡¯ç¤ºæ•¸æ“šé è¦½
        function showDataPreview() {
            if (excelData.length === 0) return;
            const actualFields = Object.keys(excelData[0]);
            let previewHtml = `
                <div class="preview-section">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 1.2rem; font-weight: 700;">ğŸ“Š æ¬„ä½æª¢æ¸¬çµæœ</h4>
                    <p style="margin-bottom: 10px;"><strong>ç¸½è³‡æ–™ç­†æ•¸ï¼š</strong>${excelData.length} ç­†</p>
                    <p style="margin-bottom: 15px;"><strong>åˆ†æç›®æ¨™æ¬„ä½ï¼š</strong>${TARGET_FIELDS.join('ã€').replace('å ±å·¥äººå“¡1', 'å ±å·¥äººå“¡1 (æ”¯æ´/åˆ†éš”ç¬¦)')}</p>
                    <div class="field-status">
            `;
            TARGET_FIELDS.forEach(field => {
                const exists = actualFields.includes(field);
                const sampleValue = exists ? (excelData[0][field] || '(ç©ºå€¼)') : '(æ¬„ä½ä¸å­˜åœ¨)';
                previewHtml += `
                    <div class="field-item ${exists ? '' : 'missing'}">
                        <div class="field-name">${field} ${exists ? 'âœ“' : 'âœ—'}</div>
                        <div class="field-value">${sampleValue}</div>
                    </div>
                `;
            });
            previewHtml += `
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 5px solid #ffc107;">
                        <small style="font-size: 0.9rem;"><strong>æª¢æ¸¬èªªæ˜ï¼š</strong>ç¶ è‰²æ¨™è¨˜è¡¨ç¤ºæ¬„ä½å­˜åœ¨ä¸”å¯æ­£å¸¸åˆ†æï¼Œç´…è‰²æ¨™è¨˜è¡¨ç¤ºæ¬„ä½ç¼ºå¤±ï¼Œå°‡å½±éŸ¿åˆ†æçµæœ</small>
                    </div>
                </div>
            `;
            const uploadSection = document.querySelector('.upload-section');
            let existingPreview = uploadSection.querySelector('.preview-section');
            if (existingPreview) existingPreview.remove();
            uploadSection.insertAdjacentHTML('beforeend', previewHtml);
        }
        
        // æ ¹æ“šæ—¥æœŸéæ¿¾æ•¸æ“š
        function filterDataByDate(data, startDate, endDate) {
            return data.filter(row => {
                let dateStr = null;
                const adjustDate = row['èª¿æ•´æ—¥æœŸ'];
                if (!adjustDate) return false;
                try {
                    if (typeof adjustDate === 'number') {
                        dateStr = excelDateToISOString(adjustDate);
                    } else if (typeof adjustDate === 'string') {
                        const rawStr = adjustDate.trim();
                        let parts = rawStr.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})/);
                        if (parts) {
                            const [_, year, month, day] = parts;
                            dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        } else {
                            const dateString = rawStr.replace(/[^\d]/g, '');
                            if (dateString.length === 8) {
                                dateStr = `${dateString.substr(0,4)}-${dateString.substr(4,2)}-${dateString.substr(6,2)}`;
                            } else {
                                const date = new Date(rawStr);
                                if (!isNaN(date.getTime())) dateStr = date.toISOString().split('T')[0];
                            }
                        }
                    } else if (adjustDate instanceof Date) {
                        dateStr = adjustDate.toISOString().split('T')[0];
                    }
                    return dateStr && dateStr >= startDate && dateStr <= endDate;
                } catch (error) {
                    return false;
                }
            });
        }
        
        // åˆ†ææ•¸æ“š
        function analyzeData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                setDefaultDates();
                alert('è«‹é¸æ“‡çµ±è¨ˆèµ·è¿„æ—¥æœŸ');
                return;
            }
            if (excelData.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³Excelæª”æ¡ˆ');
                return;
            }
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('dashboard').classList.remove('show');
            
            setTimeout(() => {
                try {
                    const filteredData = filterDataByDate(excelData, startDate, endDate);
                    if (filteredData.length === 0) {
                        alert(`åœ¨é¸å®šçš„æ—¥æœŸç¯„åœ (${startDate} ~ ${endDate}) å…§æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç¬¦åˆæ¢ä»¶çš„ç•°å¸¸æ•¸æ“šã€‚`);
                        document.getElementById('dashboard').classList.remove('show');
                    } else {
                        generateAnalysisReport(filteredData, startDate, endDate);
                        document.getElementById('dashboard').classList.add('show');
                    }
                    document.getElementById('loading').classList.remove('show');
                } catch (error) {
                    console.error('æ•¸æ“šåˆ†æä¸»æµç¨‹éŒ¯èª¤:', error);
                    alert('æ•¸æ“šåˆ†æå¤±æ•—ï¼šå¯èƒ½æ˜¯æ•¸æ“šæ ¼å¼ä¸ç¬¦ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚' + error.message);
                    document.getElementById('loading').classList.remove('show');
                }
            }, 100); 
        }
        
        // ç”Ÿæˆåˆ†æå ±å‘Š
        function generateAnalysisReport(data, startDate, endDate) {
            document.getElementById('dateRangeDisplay').textContent = 
                `çµ±è¨ˆèµ·è¿„æ—¥ï¼š${startDate.replace(/-/g, '/')} ~ ${endDate.replace(/-/g, '/')}`;
            
            const analysis = analyzeByFactoryAndDepartment(data);
            
            updateMoldingStats(analysis);
            updateAssemblyStats(analysis);
            
            // å‘¼å«æ–°çš„è©³ç´°åœ–è¡¨ç”Ÿæˆ (åœ¨æ›´æ–° Insight å‰å®Œæˆï¼Œç¢ºä¿ PDF åŒ¯å‡ºæ™‚ Chart.js ç•«å¸ƒå·²ç©©å®š)
            generateDetailedCharts(analysis);
            
            // åœ¨åœ–è¡¨ç”Ÿæˆå¾Œæ›´æ–° Insights
            updateInsights(analysis, data);
        }
        
        // æŒ‰å» å€éƒ¨é–€åˆ†ææ•¸æ“š
        function analyzeByFactoryAndDepartment(data) {
            const result = { å®—ç‘‹å» : { æˆå‹: [], çµ„è£: [] }, åšå£«å» : { æˆå‹: [], çµ„è£: [] } };
            data.forEach(row => {
                const factory = getFactory(row);
                const department = getDepartment(row);
                if (factory && department && result[factory][department]) {
                    result[factory][department].push(row);
                }
            });
            
            const stats = {};
            Object.keys(result).forEach(factory => {
                stats[factory] = {};
                Object.keys(result[factory]).forEach(dept => {
                    const deptData = result[factory][dept];
                    stats[factory][dept] = {
                        total: deptData.length,
                        dayShift: dept === 'æˆå‹' ? deptData.filter(row => getShift(row) === 'æ—¥').length : deptData.length,
                        nightShift: dept === 'æˆå‹' ? deptData.filter(row => getShift(row) === 'å¤œ').length : 0,
                        issues: analyzeIssues(deptData),
                        personnel: analyzePersonnel(deptData),
                        // æ–°å¢è©³ç´°å•é¡Œåˆ†æ
                        detailedIssues: analyzeDetailedIssues(deptData, dept),
                        rawData: deptData
                    };
                });
            });
            return stats;
        }
        
        // è­˜åˆ¥å» å€
        function getFactory(row) {
            const factory = row['å» åˆ¥']?.toString();
            if (factory?.includes('å®—ç‘‹')) return 'å®—ç‘‹å» ';
            if (factory?.includes('åšå£«')) return 'åšå£«å» ';
            return null;
        }
        
        // è­˜åˆ¥éƒ¨é–€
        function getDepartment(row) {
            const dept = row['éƒ¨é–€']?.toString();
            if (dept?.includes('æˆå‹')) return 'æˆå‹';
            if (dept?.includes('çµ„è£')) return 'çµ„è£';
            return null;
        }
        
        // è­˜åˆ¥ç­åˆ¥
        function getShift(row) {
            const shift = row['ç­åˆ¥']?.toString();
            if (shift?.includes('æ—¥')) return 'æ—¥';
            if (shift?.includes('å¤œ')) return 'å¤œ';
            return '';
        }
        
        // åˆ†æå•é¡Œé¡å‹ (åŸºç¤)
        function analyzeIssues(data) {
            const issues = {};
            data.forEach(row => {
                const reason = getReasonCategory(row);
                issues[reason] = (issues[reason] || 0) + 1;
            });
            // åˆªé™¤ 'å…¶ä»–/æœªåˆ†é¡' å¦‚æœå®ƒæ˜¯ 0
            if (issues['å…¶ä»–/æœªåˆ†é¡'] === 0) delete issues['å…¶ä»–/æœªåˆ†é¡'];
            return issues;
        }

        // æ–°å¢ - åˆ†æè©³ç´°å•é¡Œ (ç­åˆ¥ vs å•é¡Œ)
        function analyzeDetailedIssues(data, dept) {
            const detailedIssues = {
                day: { 'æ¼å ±å·¥': 0, 'æ•¸é‡éŒ¯èª¤': 0, 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)': 0, 'å…¶ä»–/æœªåˆ†é¡': 0 },
                night: { 'æ¼å ±å·¥': 0, 'æ•¸é‡éŒ¯èª¤': 0, 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)': 0, 'å…¶ä»–/æœªåˆ†é¡': 0 }
            };
            data.forEach(row => {
                let shift = 'day'; // çµ„è£éƒ¨é–€é è¨­ç‚ºæ—¥ç­
                if (dept === 'æˆå‹') {
                    const shiftStr = getShift(row);
                    if (shiftStr === 'å¤œ') shift = 'night';
                }
                const reason = getReasonCategory(row);
                detailedIssues[shift][reason]++;
            });
            return detailedIssues;
        }

        // æ–°å¢ - æ­¸é¡å•é¡Œ (Helper)
        function getReasonCategory(row) {
            const reasonStr = row['èª¿æ•´åŸå› '] ? row['èª¿æ•´åŸå› '].toString() : '';
            if (reasonStr.includes('æ¼å ±å·¥')) return 'æ¼å ±å·¥';
            if (reasonStr.includes('æ•¸é‡éŒ¯èª¤')) return 'æ•¸é‡éŒ¯èª¤';
            if (reasonStr.includes('æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)')) return 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)';
            return 'å…¶ä»–/æœªåˆ†é¡';
        }
        
        // åˆ†æäººå“¡çµ±è¨ˆ
        function analyzePersonnel(data) {
            const personnel = {};
            data.forEach(row => {
                const shift = getShift(row);
                const person1 = row['å ±å·¥äººå“¡1'];
                if (person1 && person1.toString().trim() !== '') {
                    const names = person1.toString().split('/').map(name => name.trim()).filter(name => name !== '');
                    names.forEach(personName => {
                        // åªéœ€è¦ totalï¼Œä¸å†éœ€è¦ shifts è³‡è¨Š
                        if (!personnel[personName]) personnel[personName] = { total: 0, shifts: {} };
                        personnel[personName].total++;
                        // if (shift) personnel[personName].shifts[shift] = (personnel[personName].shifts[shift] || 0) + 1; // ç§»é™¤ç­åˆ¥çµ±è¨ˆé‚è¼¯
                    });
                }
            });
            
            const result = {};
            Object.keys(personnel).forEach(person => {
                // é€™è£¡çš„é‚è¼¯ä¸è®Š: ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡æ‰åˆ—å‡º
                if (personnel[person].total > 3) {
                    // ç°¡åŒ– result çµæ§‹ï¼Œä¸å†éœ€è¦ shift è³‡è¨Š
                    result[person] = { total: personnel[person].total }; 
                }
            });
            return result;
        }
        
        // æ›´æ–°æˆå‹éƒ¨é–€çµ±è¨ˆ (å·²ä¿®æ”¹ç™¾åˆ†æ¯”é‚è¼¯)
        function updateMoldingStats(analysis) {
            const zongweiMolding = analysis['å®—ç‘‹å» ']['æˆå‹'];
            const bossMolding = analysis['åšå£«å» ']['æˆå‹'];
            
            // NEW: Combined Total for Percentage Calculation
            const moldingTotalCombined = zongweiMolding.total + bossMolding.total;

            // å®—ç‘‹å» 
            document.getElementById('zongweiMoldingTotal').textContent = `${zongweiMolding.total} æ¬¡`;
            // ä¿®æ­£: ç™¾åˆ†æ¯”æ”¹ç‚ºä½”å…©å» æˆå‹ç¸½æ•¸çš„æ¯”ä¾‹
            const zongweiDayPct = moldingTotalCombined > 0 ? ((zongweiMolding.dayShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            const zongweiNightPct = moldingTotalCombined > 0 ? ((zongweiMolding.nightShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            
            document.getElementById('zongweiMoldingDay').textContent = `${zongweiMolding.dayShift} æ¬¡ (${zongweiDayPct}%)`;
            document.getElementById('zongweiMoldingNight').textContent = `${zongweiMolding.nightShift} æ¬¡ (${zongweiNightPct}%)`;
            updateIssuesDisplay('zongweiMoldingIssues', zongweiMolding.issues, zongweiMolding.total);
            
            // åšå£«å» 
            document.getElementById('bossMoldingTotal').textContent = `${bossMolding.total} æ¬¡`;
            // ä¿®æ­£: ç™¾åˆ†æ¯”æ”¹ç‚ºä½”å…©å» æˆå‹ç¸½æ•¸çš„æ¯”ä¾‹
            const bossDayPct = moldingTotalCombined > 0 ? ((bossMolding.dayShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            const bossNightPct = moldingTotalCombined > 0 ? ((bossMolding.nightShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            
            document.getElementById('bossMoldingDay').textContent = `${bossMolding.dayShift} æ¬¡ (${bossDayPct}%)`;
            // ä¿®æ­£ï¼šå°‡ bossMoldingNight æ”¹ç‚º bossNightPct
            document.getElementById('bossMoldingNight').textContent = `${bossMolding.nightShift} æ¬¡ (${bossNightPct}%)`;
            updateIssuesDisplay('bossMoldingIssues', bossMolding.issues, bossMolding.total);

            // æ›´æ–°äººå“¡
            updatePersonnelDisplay('zongweiMoldingPersonnel', 'zongweiMoldingPersonnelTitle', analysis['å®—ç‘‹å» ']['æˆå‹'].personnel, 'å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
            updatePersonnelDisplay('bossMoldingPersonnel', 'bossMoldingPersonnelTitle', analysis['åšå£«å» ']['æˆå‹'].personnel, 'åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
        }
        
        // æ›´æ–°çµ„è£éƒ¨é–€çµ±è¨ˆ
        function updateAssemblyStats(analysis) {
            const zongweiAssembly = analysis['å®—ç‘‹å» ']['çµ„è£'];
            const bossAssembly = analysis['åšå£«å» ']['çµ„è£'];
            
            document.getElementById('zongweiAssemblyTotal').textContent = `${zongweiAssembly.total} æ¬¡`;
            document.getElementById('bossAssemblyTotal').textContent = `${bossAssembly.total} æ¬¡`;
            
            updateIssuesDisplay('zongweiAssemblyIssues', zongweiAssembly.issues, zongweiAssembly.total);
            updateIssuesDisplay('bossAssemblyIssues', bossAssembly.issues, bossAssembly.total);

            // æ›´æ–°äººå“¡
            updatePersonnelDisplay('zongweiAssemblyPersonnel', 'zongweiAssemblyPersonnelTitle', analysis['å®—ç‘‹å» ']['çµ„è£'].personnel, 'å®—ç‘‹å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
            updatePersonnelDisplay('bossAssemblyPersonnel', 'bossAssemblyPersonnelTitle', analysis['åšå£«å» ']['çµ„è£'].personnel, 'åšå£«å»  - ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡äººå“¡');
        }
        
        // æ›´æ–°å•é¡Œé¡å‹é¡¯ç¤º
        function updateIssuesDisplay(elementId, issues, total) {
            const element = document.getElementById(elementId);
            if (total === 0) {
                element.innerHTML = '<div style="text-align: center; color: #28a745; font-weight: 600; padding: 10px; font-size: 1.1rem;">âœ… ç„¡ç•°å¸¸è¨˜éŒ„</div>';
                return;
            }
            let html = '';
            const issueArray = Object.keys(issues).map(issue => ({
                name: issue,
                count: issues[issue]
            })).sort((a, b) => b.count - a.count);

            issueArray.forEach(issue => {
                const count = issue.count;
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                html += `
                    <div class="stats-row">
                        <span class="stat-label">${issue.name}</span>
                        <span class="stat-value">${count} æ¬¡ (${percentage}%)</span>
                    </div>
                `;
            });
            element.innerHTML = html;
        }
        
        // æ›´æ–°äººå“¡çµ±è¨ˆé¡¯ç¤º (å·²ä¿®æ”¹: ç§»é™¤ç­åˆ¥é¡¯ç¤º)
        function updatePersonnelDisplay(elementId, titleId, personnel, titleText) {
            const element = document.getElementById(elementId);
            const titleElement = document.getElementById(titleId);
            // ç”±æ–¼ analyzePersonnel å·²ç¶“ç°¡åŒ–äº†çµæ§‹ï¼Œé€™è£¡çš„ map åªéœ€è¦ name å’Œ total
            const personnelArray = Object.keys(personnel).map(name => ({
                name: name,
                count: personnel[name].total,
                // shift: personnel[name].shift // ç§»é™¤ shift ç›¸é—œæ¬„ä½
            })).sort((a, b) => b.count - a.count);
            
            const totalPersonnel = Object.keys(personnel).length;
            titleElement.textContent = `${titleText} (${totalPersonnel}ä½)`;

            if (personnelArray.length === 0) {
                element.innerHTML = '<div class="no-personnel">âœ… ç„¡äººå“¡ç™¼ç”Ÿæ¬¡æ•¸å¤§æ–¼3æ¬¡</div>';
                return;
            }
            
            let html = '<div class="personnel-grid">';
            html += '<ul class="personnel-list">';
            personnelArray.forEach(person => {
                // æ ¸å¿ƒä¿®æ”¹: ç§»é™¤ (${person.shift || 'æœªçŸ¥'}ç­)
                html += `
                    <li class="personnel-item">
                        <span class="personnel-name">${person.name}</span>
                        <span class="personnel-count">${person.count}æ¬¡</span>
                    </li>
                `;
            });
            html += '</ul></div>';
            element.innerHTML = html;
        }
        
        // ç”Ÿæˆæ–°çš„è©³ç´°åœ–è¡¨
        function generateDetailedCharts(analysis) {
            Object.keys(charts).forEach(key => {
                if (charts[key]) charts[key].destroy();
            });
            
            const zongweiData = analysis['å®—ç‘‹å» ']['æˆå‹'].detailedIssues;
            const bossData = analysis['åšå£«å» ']['æˆå‹'].detailedIssues;
            
            const chartLabels = MAIN_ISSUES.slice(0, 3); // åªé¡¯ç¤ºå‰ä¸‰å¤§å•é¡Œ
            
            // --- Start of new logic to find Global Max for uniform scale ---
            let globalMax = 0;
            chartLabels.forEach(issue => {
                globalMax = Math.max(globalMax, zongweiData.day[issue], zongweiData.night[issue]);
                globalMax = Math.max(globalMax, bossData.day[issue], bossData.night[issue]);
            });
            
            // ç¢ºä¿ Y è»¸æœ€å¤§å€¼è¶³å¤ é¡¯ç¤ºï¼Œä¸”æœ‰è¦–è¦ºä¸Šçš„ç·©è¡
            let displayMax = globalMax;

            if (globalMax === 0) {
                displayMax = 10;
            } else if (globalMax < 5) {
                displayMax = 5;
            } else {
                // å‘ä¸Šå–æ•´åˆ°æœ€è¿‘çš„ 5 çš„å€æ•¸ï¼Œä¸¦ç¢ºä¿æ¯” globalMax å¤§ (e.g., 62 -> 65)
                displayMax = Math.ceil((globalMax + 1) / 5) * 5;
            }
            // --- End of new logic ---


            // å®—ç‘‹å» è©³ç´°åœ–è¡¨
            const zongweiCtx = document.getElementById('zongweiMoldingDetailedChart').getContext('2d');
            charts['zongweiDetailed'] = new Chart(zongweiCtx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'æ—¥ç­',
                            data: chartLabels.map(issue => zongweiData.day[issue]),
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'å¤œç­',
                            data: chartLabels.map(issue => zongweiData.night[issue]),
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: getDetailedChartOptions(displayMax) // <--- Pass the calculated max value
            });
            
            // åšå£«å» è©³ç´°åœ–è¡¨
            const bossCtx = document.getElementById('bossMoldingDetailedChart').getContext('2d');
            charts['bossDetailed'] = new Chart(bossCtx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'æ—¥ç­',
                            data: chartLabels.map(issue => bossData.day[issue]),
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'å¤œç­',
                            data: chartLabels.map(issue => bossData.night[issue]),
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: getDetailedChartOptions(displayMax) // <--- Pass the calculated max value
            });
        }
        
        // æ–°çš„åœ–è¡¨è¨­å®š - æ¥å—ä¸€å€‹åƒæ•¸ä¾†è¨­å®š Y è»¸çš„æœ€å¤§å€¼
        function getDetailedChartOptions(globalMax) { // <--- Receive the max value
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { font: { size: 14 } } },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: globalMax, // <--- Set the calculated max scale here
                        ticks: { 
                            stepSize: globalMax > 20 ? Math.ceil(globalMax / 5) : 5, // Dynamic step size, crude but works
                            font: { size: 12 } 
                        } 
                    },
                    x: { ticks: { font: { size: 14 } } }
                }
            };
        }
        
        // æ›´æ–°æ´å¯Ÿåˆ†æ
        function updateInsights(analysis, rawData) {
            const totalIssues = Object.values(analysis).reduce((sum, factory) => sum + Object.values(factory).reduce((deptSum, dept) => deptSum + dept.total, 0), 0);
            const allIssues = {};
            Object.values(analysis).forEach(factory => {
                Object.values(factory).forEach(dept => {
                    Object.keys(dept.issues).forEach(issue => {
                        allIssues[issue] = (allIssues[issue] || 0) + dept.issues[issue];
                    });
                });
            });
            const zongweiAssemblyTotal = analysis['å®—ç‘‹å» ']['çµ„è£'].total;
            const bossAssemblyTotal = analysis['åšå£«å» ']['çµ„è£'].total;
            
            // --- è®Šæ›´é–‹å§‹: æ•´åˆåˆ†æé …ç›® ---
            // ç¢ºä¿çµ„è£éƒ¨é–€åˆ†æåªåœ¨æœ‰æ•¸æ“šæ™‚é¡¯ç¤ºï¼Œé¿å…ç„¡æ„ç¾©çš„ä½”ä½
            const insights = [
                // é …ç›® 1: åˆä½µ (ç­åˆ¥å·®ç•° + ç¸½é«”è¶¨å‹¢)
                { title: "ğŸ”§ æˆå‹ç­åˆ¥ & å…©å» ç¸½é«”è¶¨å‹¢", fn: generateMergedShiftTrendAnalysis }, 
                // é …ç›® 2: åˆä½µ (å•é¡Œé¡å‹ + é‡é»äººå“¡)
                { title: "âš ï¸ ä¸»è¦å•é¡Œ & é‡é»äººå“¡åˆ†æ", fn: generateMergedIssuePersonnelAnalysis },    
                // é …ç›® 3: çµ„è£
                { title: "ğŸ“¦ çµ„è£éƒ¨é–€è¡¨ç¾åˆ†æ", fn: generateAssemblyAnalysis, condition: (zongweiAssemblyTotal > 0 || bossAssemblyTotal > 0) }, 
                // é …ç›® 4: çµè«–
                { title: "ğŸ’¡ çµè«–èˆ‡æµç¨‹æ”¹å–„æ–¹å‘", fn: generateRecommendations } 
            ];
            // --- è®Šæ›´çµæŸ ---
            
            let html = '';
            // éæ¿¾æ‰ä¸ç¬¦åˆæ¢ä»¶çš„é …ç›®ï¼Œä»¥å–å¾—å¯¦éš›é¡¯ç¤ºçš„é …ç›®æ•¸
            const filteredInsights = insights.filter(insight => insight.condition !== false);

            filteredInsights.forEach((insight, index) => { 
                const result = insight.fn(analysis, totalIssues, allIssues); 
                let contentHtml;
                
                // --- è®Šæ›´é–‹å§‹: è™•ç†åˆä½µå¾Œçš„ HTML ---
                if (result.isMerged) {
                    contentHtml = result.htmlContent;
                }
                // --- è®Šæ›´çµæŸ ---
                // æª¢æŸ¥æ˜¯å¦ç‚ºçµæ§‹åŒ–å…§å®¹ (åˆ—è¡¨)
                else if (result.isStructured) {
                    const listHtml = result.list.map((item) => `<li>${item.title}ï¼š ${item.content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</li>`).join('');
                    
                    // --- ä¿®æ­£ Change 3: é‡å°ã€Œçµè«–èˆ‡æµç¨‹æ”¹å–„æ–¹å‘ã€çš„ç‰¹æ®Šæ¸²æŸ“ ---
                    if (insight.title === "ğŸ’¡ çµè«–èˆ‡æµç¨‹æ”¹å–„æ–¹å‘") {
                        // åƒ…é¡¯ç¤ºæ¨™é¡Œ (summaryText) å’Œåˆ—è¡¨ (listHtml)ï¼Œé¿å…å¤šé¤˜çš„ <p> æ¨™ç±¤å’Œé‡è¤‡çš„æ¨™é¡Œ
                        contentHtml = `
                            <p><b>${result.summary}</b></p>
                            <ul>${listHtml}</ul>
                        `;
                    } else {
                        // æ¨™æº–çµæ§‹åŒ–å…§å®¹æ¸²æŸ“
                        contentHtml = `
                            <p>${result.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
                            <p style="margin-top: 10px;"><b>å»ºè­°çš„æµç¨‹æ”¹å–„æ–¹å‘æ‡‰è‘—é‡æ–¼ï¼š</b></p>
                            <ul>${listHtml}</ul>
                        `;
                    }
                } else {
                    // éçµæ§‹åŒ–å…§å®¹
                    // é€™è£¡çš„ replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') æœƒè™•ç†ç²—é«”
                    contentHtml = `<p>${result.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>`;
                }
                
                // --- è®Šæ›´é–‹å§‹: èª¿æ•´ span-full é‚è¼¯ ---
                // å¦‚æœéæ¿¾å¾Œçš„é …ç›®ç¸½æ•¸æ˜¯å¥‡æ•¸ï¼Œå‰‡è®“æœ€å¾Œä¸€å€‹é …ç›® (çµè«–) ä½”æ»¿æ•´è¡Œ
                const spanClass = (filteredInsights.length % 2 === 1 && index === filteredInsights.length - 1) ? ' span-full' : '';
                // --- è®Šæ›´çµæŸ ---
                
                html += `
                    <div class="insight-item${spanClass}">
                        <h4>${insight.title}</h4>
                        <div class="insight-content-box">${contentHtml}</div>
                    </div>
                `;
            });
            document.getElementById('insightsGrid').innerHTML = html;
        }
        
        // --- è®Šæ›´é–‹å§‹: æ–°å¢åˆä½µçš„åˆ†æå‡½å¼ ---
        // ğŸ”§ (åˆä½µ) æˆå‹éƒ¨é–€ç­åˆ¥å·®ç•° & å…©å» ç¸½é«”è¶¨å‹¢
        function generateMergedShiftTrendAnalysis(analysis, totalIssues, allIssues) {
            const shiftResult = generateShiftAnalysis(analysis, totalIssues, allIssues);
            const trendResult = generateTrendAnalysis(analysis, totalIssues, allIssues);
            
            // é€é <hr> åˆ†éš”ç·šåˆä½µå…©å€‹åˆ†æçš„ HTML
            const combinedHtml = `
                <p>${shiftResult.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
                <hr style="margin: 15px 0; border-top: 2px solid #e0e7ff;">
                <p>${trendResult.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
            `;
            
            // è¿”å›ä¸€å€‹å¸¶æœ‰ 'isMerged' æ¨™è¨˜çš„ç‰¹æ®Šç‰©ä»¶
            return { htmlContent: combinedHtml, isMerged: true };
        }

        // âš ï¸ (åˆä½µ) å•é¡Œé¡å‹ç¸½é«”åˆ†æ & é‡é»é—œæ³¨äººå“¡å»ºè­°
        function generateMergedIssuePersonnelAnalysis(analysis, totalIssues, allIssues) {
            const issueResult = generateIssueAnalysis(analysis, totalIssues, allIssues);
            const personnelResult = generatePersonnelAnalysis(analysis, totalIssues, allIssues);

            const combinedHtml = `
                <p>${issueResult.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
                <hr style="margin: 15px 0; border-top: 2px solid #e0e7ff;">
                <p>${personnelResult.summary.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
            `;
            
            return { htmlContent: combinedHtml, isMerged: true };
        }
        // --- è®Šæ›´çµæŸ ---

        // ğŸ”§ æˆå‹éƒ¨é–€ç­åˆ¥å·®ç•°åˆ†æ (ä¿®æ­£é‚è¼¯: ä¾æ“šæ¬¡æ•¸, ä¸¦ä¿®æ­£çµè«–æªè¾­)
        function generateShiftAnalysis(analysis, totalIssues, allIssues) {
            const zongwei = analysis['å®—ç‘‹å» ']['æˆå‹'];
            const boss = analysis['åšå£«å» ']['æˆå‹'];
            
            // NEW: ç²å–å…©å» æˆå‹éƒ¨é–€ç¸½æ•¸
            const moldingTotalCombined = zongwei.total + boss.total;
            
            // ä¿®æ­£: ç™¾åˆ†æ¯”æ”¹ç‚ºä½”å…©å» æˆå‹ç¸½æ•¸çš„æ¯”ä¾‹ (é€™æ˜¯ä½¿ç”¨è€…è¦æ±‚çš„é—œéµä¿®æ­£)
            const zongweiDayPct = moldingTotalCombined > 0 ? ((zongwei.dayShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            const zongweiNightPct = moldingTotalCombined > 0 ? ((zongwei.nightShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            const bossDayPct = moldingTotalCombined > 0 ? ((boss.dayShift / moldingTotalCombined) * 100).toFixed(1) : 0;
            const bossNightPct = moldingTotalCombined > 0 ? ((boss.nightShift / moldingTotalCombined) * 100).toFixed(1) : 0;

            const zongweiTotalPct = moldingTotalCombined > 0 ? ((zongwei.total / moldingTotalCombined) * 100).toFixed(1) : 0;
            const bossTotalPct = moldingTotalCombined > 0 ? ((boss.total / moldingTotalCombined) * 100).toFixed(1) : 0;

            // 1. æ•¸æ“šåˆ†ä½ˆå…§æ–‡ (Updated to show contribution to total molding issues)
            let result = `**å®—ç‘‹å» ** æˆå‹éƒ¨é–€ (ç¸½ **${zongwei.total}** æ¬¡) ä½”ç¸½æˆå‹ç•°å¸¸çš„ **${zongweiTotalPct}%**ï¼š<br>`;
            result += `æ—¥ç­ **${zongwei.dayShift}** æ¬¡ (**${zongweiDayPct}**%)ï¼Œå¤œç­ **${zongwei.nightShift}** æ¬¡ (**${zongweiNightPct}**%)ã€‚<br>`;
            
            result += `**åšå£«å» ** æˆå‹éƒ¨é–€ (ç¸½ **${boss.total}** æ¬¡) ä½”ç¸½æˆå‹ç•°å¸¸çš„ **${bossTotalPct}%**ï¼š<br>`;
            result += `æ—¥ç­ **${boss.dayShift}** æ¬¡ (**${bossDayPct}**%)ï¼Œå¤œç­ **${boss.nightShift}** æ¬¡ (**${bossNightPct}**%)ã€‚<br>`;

            // 2. åˆ¤æ–·æ¬¡æ•¸æœ€å¤šè€… (æ–°é‚è¼¯)
            let highShiftFactory = '';
            let highShift = '';
            let maxCount = -1; 
            
            const countData = [
                { factory: 'å®—ç‘‹å» ', shift: 'å¤œç­', count: zongwei.nightShift },
                { factory: 'å®—ç‘‹å» ', shift: 'æ—¥ç­', count: zongwei.dayShift },
                { factory: 'åšå£«å» ', shift: 'å¤œç­', count: boss.nightShift },
                { factory: 'åšå£«å» ', shift: 'æ—¥ç­', count: boss.dayShift }
            ];

            countData.forEach(d => {
                if (d.count > maxCount) {
                    maxCount = d.count;
                    highShiftFactory = d.factory;
                    highShift = d.shift;
                }
            });

            // 3. çµè«–ä½¿ç”¨æ–°æªè¾­
            if (highShiftFactory && maxCount > 0) {
                 // çµè«–æªè¾­ä¿®æ­£ç‚º: "çµè«–ï¼šå®—ç‘‹å»  çš„ å¤œç­ ä½”ç•°å¸¸æ¬¡æ•¸æœ€å¤šã€‚"
                 result += `çµè«–ï¼š**${highShiftFactory}** çš„ **${highShift}** ä½”ç•°å¸¸æ¬¡æ•¸æœ€å¤šã€‚`;
            } else {
                 // è™•ç†ç„¡æ•¸æ“šæˆ–æ•¸æ“šçš†ç‚º 0 çš„æƒ…æ³
                 result += `çµè«–ï¼šå…©å» æ—¥å¤œç­çš„ç•°å¸¸åˆ†ä½ˆç›¸å°å¹³å‡ï¼Œè¡¨ç¤ºå•é¡Œå¯èƒ½ä¾†è‡ªæ–¼è·¨ç­åˆ¥çš„ **é€šç”¨æµç¨‹** æˆ– **ç³»çµ±æ“ä½œ**ã€‚`;
            }

            return { summary: result, isStructured: false };
        }
        
        // âš ï¸ å•é¡Œé¡å‹ç¸½é«”åˆ†æ
        function generateIssueAnalysis(analysis, totalIssues, allIssues) { 
            if (totalIssues === 0) return { summary: "æœ¬æœŸé–“å…§ç„¡ç•°å¸¸è¨˜éŒ„ï¼Œå„éƒ¨é–€é‹ä½œè‰¯å¥½ï¼Œå»ºè­°æŒçºŒä¿æŒä¸¦å®šæœŸå¯©æŸ¥å ±å·¥æµç¨‹ã€‚", isStructured: false };
            
            const leakPct = allIssues['æ¼å ±å·¥'] ? ((allIssues['æ¼å ±å·¥'] / totalIssues) * 100).toFixed(1) : 0;
            const quantityPct = allIssues['æ•¸é‡éŒ¯èª¤'] ? ((allIssues['æ•¸é‡éŒ¯èª¤'] / totalIssues) * 100).toFixed(1) : 0;
            const noStartPct = allIssues['æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)'] ? ((allIssues['æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)'] / totalIssues) * 100).toFixed(1) : 0;
            
            let maxIssueCount = 0;
            let maxIssueShiftDetail = null;
            const allRawData = [ 
                ...analysis['å®—ç‘‹å» ']['æˆå‹'].rawData, 
                ...analysis['å®—ç‘‹å» ']['çµ„è£'].rawData, 
                ...analysis['åšå£«å» ']['æˆå‹'].rawData, 
                ...analysis['åšå£«å» ']['çµ„è£'].rawData 
            ];
            const shiftIssueCounts = {}; 
            allRawData.forEach(row => {
                const factory = getFactory(row);
                const dept = getDepartment(row);
                const shift = getShift(row) || 'æ—¥'; 
                const reason = getReasonCategory(row);
                if (MAIN_ISSUES.includes(reason) && reason !== 'å…¶ä»–/æœªåˆ†é¡') {
                    const key = `${factory}_${dept}_${shift}_${reason}`;
                    shiftIssueCounts[key] = (shiftIssueCounts[key] || 0) + 1;
                }
            });
            Object.keys(shiftIssueCounts).forEach(key => {
                const currentCount = shiftIssueCounts[key];
                if (currentCount > maxIssueCount) {
                    maxIssueCount = currentCount;
                    const [factory, dept, shift, reason] = key.split('_');
                    // å„²å­˜è³‡è¨Šä»¥ä¾›å¾ŒçºŒç²¾ç¢ºæ ¼å¼åŒ–
                    maxIssueShiftDetail = { factory, shift, reason, count: maxIssueCount };
                }
            });

            // é‡æ–°å»ºæ§‹ç¬¦åˆä½¿ç”¨è€…æ¨¡æ¿çš„å…§æ–‡
            let summary = `æœ¬æœŸç¸½ç•°å¸¸æ¬¡æ•¸ç‚º **${totalIssues}** æ¬¡ï¼Œåˆ†æçµæœå¦‚ä¸‹ï¼š`;
            summary += `<br>**æ¼å ±å·¥** ä½”ç¸½ç•°å¸¸çš„ **${leakPct}%**`;
            summary += `<br>**æ•¸é‡éŒ¯èª¤** ä½” **${quantityPct}%**ï¼Œä»¥åŠ **æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)** ä½” **${noStartPct}%**ã€‚`;
            
            if (maxIssueShiftDetail) {
                 const plainSentencePart1 = `<br>å…¶ä¸­ <b>${maxIssueShiftDetail.factory}</b> çš„ <b>${maxIssueShiftDetail.shift}ç­</b> åœ¨ <b>${maxIssueShiftDetail.reason}</b> é …ç›®ä¸Šç™¼ç”Ÿäº†æœ€é«˜çš„ ${maxIssueShiftDetail.count} æ¬¡ç•°å¸¸ï¼Œ`;
                 // ä¿®æ­£ 2: é€™è£¡åŠ ä¸Š <br> ä»¥ç¢ºä¿æ›è¡Œ
                 const plainSentencePart2 = `<br>æ‡‰ä½œç‚ºå„ªå…ˆæ”¹å–„çš„ç›®æ¨™ã€‚`; 
                 summary += plainSentencePart1 + plainSentencePart2;

            } else if (allIssues['å…¶ä»–/æœªåˆ†é¡'] > 0) {
                 summary += `<br><br>ä¸»è¦ç•°å¸¸é›†ä¸­åœ¨ **å…¶ä»–/æœªåˆ†é¡**ï¼Œè«‹åŠ å¼·å®£å°å¡«å¯«å®Œæ•´åŸå› ã€‚`;
            }

            return { summary: summary, isStructured: false };
        }

        // ğŸ“¦ çµ„è£éƒ¨é–€è¡¨ç¾åˆ†æ (ä¸è®Šå‹•)
        function generateAssemblyAnalysis(analysis, totalIssues, allIssues) {
            const zongwei = analysis['å®—ç‘‹å» ']['çµ„è£'];
            const boss = analysis['åšå£«å» ']['çµ„è£'];
            let summary = `**çµ„è£éƒ¨é–€** ç¸½ç•°å¸¸æ¬¡æ•¸ï¼šå®—ç‘‹å»  **${zongwei.total}** æ¬¡ï¼Œåšå£«å»  **${boss.total}** æ¬¡ã€‚`;
            if (zongwei.total > boss.total) {
                summary += ` å®—ç‘‹å» çš„ç•°å¸¸æ¬¡æ•¸è¼ƒé«˜ï¼Œæ‡‰å„ªå…ˆå¯©è¦–å®—ç‘‹å» çµ„è£éƒ¨é–€çš„å ±å·¥æµç¨‹ï¼Œç‰¹åˆ¥æ˜¯å…¶ **æ•¸é‡éŒ¯èª¤** (${zongwei.issues['æ•¸é‡éŒ¯èª¤'] || 0} æ¬¡) æˆ– **æ¼å ±å·¥** (${zongwei.issues['æ¼å ±å·¥'] || 0} æ¬¡) é »ç‡ã€‚`;
            } else if (boss.total > zongwei.total) {
                 summary += ` åšå£«å» çš„ç•°å¸¸æ¬¡æ•¸è¼ƒé«˜ï¼Œå»ºè­°åšå£«å» çµ„è£éƒ¨é–€æ‡‰ç¢ºèª SOP åŸ·è¡Œæ¨™æº–ï¼Œä¸¦åŠ å¼·å ±å·¥ç¨½æ ¸ï¼Œä»¥é™ä½ç¸½é«”éŒ¯èª¤ç‡ã€‚`;
            } else if (zongwei.total > 0) {
                summary += ` å…©å» æ¬¡æ•¸ç›¸è¿‘ï¼Œä½†ç¸½æ•¸ä¸å¤§ï¼Œå»ºè­°ç¶­æŒç¾æœ‰ç¨½æ ¸å¼·åº¦ï¼Œé‡é»é—œæ³¨äººå“¡çš„è¡¨ç¾ã€‚`;
            } else {
                 summary += ` å…©å» çµ„è£éƒ¨é–€è¡¨ç¾å„ªç•°ï¼Œå‡ç„¡ç•°å¸¸è¨˜éŒ„ã€‚`;
            }
            return { summary: summary, isStructured: false };
        }
        
        // ğŸ‘¥ é‡é»é—œæ³¨äººå“¡å»ºè­°
        function generatePersonnelAnalysis(analysis, totalIssues, allIssues) {
            let totalHighFreq = 0;
            Object.values(analysis).forEach(factory => Object.values(factory).forEach(dept => { totalHighFreq += Object.keys(dept.personnel).length; }));
            
            if (totalHighFreq === 0) return { summary: "æœ¬æœŸé–“å…§æ‰€æœ‰äººå“¡å ±å·¥è¡¨ç¾å„ªç•°ï¼Œç„¡äººå“¡å–®æœˆç™¼ç”Ÿç•°å¸¸æ¬¡æ•¸è¶…é3æ¬¡ï¼Œé¡¯ç¤ºéƒ¨é–€æ•´é«”æ“ä½œè¦ç¯„åŸ·è¡Œåº¦é«˜ã€‚", isStructured: false };
            
            const zongweiPersonnelCount = Object.keys(analysis['å®—ç‘‹å» ']['æˆå‹'].personnel).length + Object.keys(analysis['å®—ç‘‹å» ']['çµ„è£'].personnel).length;
            const bossPersonnelCount = Object.keys(analysis['åšå£«å» ']['æˆå‹'].personnel).length + Object.keys(analysis['åšå£«å» ']['çµ„è£'].personnel).length;
            
            let highestFactory = '';
            if (zongweiPersonnelCount > bossPersonnelCount) highestFactory = 'å®—ç‘‹å» ';
            else if (bossPersonnelCount > zongweiPersonnelCount) highestFactory = 'åšå£«å» ';
            
            // é‡æ–°å»ºæ§‹ç¬¦åˆä½¿ç”¨è€…æ¨¡æ¿çš„å…§æ–‡
            let summary = `æœ¬æœŸé–“å…±è¨ˆ **${totalHighFreq}** ä½äººå“¡ç™¼ç”Ÿæ¬¡æ•¸>3æ¬¡ã€‚`; 
            
            if (highestFactory) {
                 // FIX 3: ç§»é™¤ 'ä¸¦å®‰æ’å†æ•™è‚²æˆ–è¼”å°'
                 summary += `<br>æ‡‰å„ªå…ˆç¢ºèª **${highestFactory}** çš„é‡é»é—œæ³¨äººå“¡ **SOPç†è§£èˆ‡åŸ·è¡Œç‹€æ³æ˜¯å¦æ­£ç¢º**ã€‚`;
            } else {
                 summary += `<br>å…©å» åœ¨äººå“¡ç•°å¸¸æ¬¡æ•¸çš„åˆ†ä½ˆä¸Šç›¸å°å¹³å‡ï¼Œå»ºè­°å…©å» åŒæ™‚å±•é–‹ SOP åŸ·è¡Œç¢ºèªã€‚`;
            }

            return { summary: summary, isStructured: false };
        }

        // ğŸ­ å…©å» ç¸½é«”ç•°å¸¸è¶¨å‹¢æ¯”è¼ƒ (å·²ä¿®æ­£ï¼šæ–°å¢ç²—é«”çªé¡¯)
        function generateTrendAnalysis(analysis, totalIssues, allIssues) {
            const zongweiTotal = analysis['å®—ç‘‹å» ']['æˆå‹'].total + analysis['å®—ç‘‹å» ']['çµ„è£'].total;
            const bossTotal = analysis['åšå£«å» ']['æˆå‹'].total + analysis['åšå£«å» ']['çµ„è£'].total;
            
            if (totalIssues === 0) {
                 return { summary: "æœ¬æœŸé–“å…©å» åœ¨ç•°å¸¸ç®¡æ§ä¸Šè¡¨ç¾å„ªç•°ï¼Œé”åˆ°é›¶ç•°å¸¸çš„ç†æƒ³ç‹€æ…‹ã€‚", isStructured: false };
            } 
            
            // é‡æ–°å»ºæ§‹ç¬¦åˆä½¿ç”¨è€…æ¨¡æ¿çš„å…§æ–‡
            let summary = `æœ¬æœŸé–“å…©å» ç¸½è¨ˆç™¼ç”Ÿ **${totalIssues}** æ¬¡ç•°å¸¸ã€‚`; 
            // ä¿®æ­£: çªé¡¯å…©å» ç¸½æ¬¡æ•¸
            summary += `<br>**å®—ç‘‹å» ** ç¸½æ¬¡æ•¸ç‚º **${zongweiTotal} æ¬¡**ï¼Œ**åšå£«å» ** ç¸½æ¬¡æ•¸ç‚º **${bossTotal} æ¬¡**ã€‚`;

            if (zongweiTotal > bossTotal) {
                summary += `<br>æ‡‰å„ªå…ˆå¯©è¦– **å®—ç‘‹å» ** æ•´é«”å ±å·¥æµç¨‹æ˜¯å¦æ­£ç¢ºã€‚`;
            } else if (bossTotal > zongweiTotal) {
                summary += `<br>æ‡‰å„ªå…ˆå¯©è¦– **åšå£«å» ** æ•´é«”å ±å·¥æµç¨‹æ˜¯å¦æ­£ç¢ºã€‚`;
            } else {
                summary += `<br>å…©å» ç•°å¸¸ç¸½æ•¸æ¥è¿‘ (**${zongweiTotal}** æ¬¡ vs **${bossTotal}** æ¬¡)ï¼Œå»ºè­°åŒæ™‚é€²è¡Œæµç¨‹å„ªåŒ–ï¼Œä»¥é”åˆ°å…±åŒé™ä½ç•°å¸¸ç‡çš„ç›®æ¨™ã€‚`;
            }

            return { summary: summary, isStructured: false };
        }

        // ğŸ’¡ çµè«–èˆ‡æµç¨‹æ”¹å–„æ–¹å‘ (å·²ä¿®æ­£ï¼šç‚ºé—œéµè©å½™é‡æ–°åŠ å…¥ç²—é«”)
        function generateRecommendations(analysis, totalIssues, allIssues) {
            
            if (totalIssues === 0) {
                return { summary: "æœ¬æœŸæ•´é«”å ±å·¥æº–ç¢ºåº¦æ¥µé«˜ï¼Œå»ºè­°å°‡æœ¬æœŸSOPå’Œå ±å·¥ç’°å¢ƒä½œç‚ºæ¨™ç«¿ï¼Œä¸¦æŒçºŒç›£æ¸¬ç•°å¸¸äººå“¡åå–®ï¼Œé€²è¡Œé é˜²æ€§æé†’ã€‚", isStructured: false };
            }
            // ä¿®æ­£ 3-1: summaryText æ”¹ç‚ºæ¸…å–®å‰çš„å¼•å°å¥
            const summaryText = `å»ºè­°çš„æµç¨‹æ”¹å–„æ–¹å‘æ‡‰è‘—é‡æ–¼ï¼š`; 
            
            // ä¿®æ­£ 3-2: ç‚º list content ä¸­çš„é—œéµè©å½™é‡æ–°åŠ å…¥ç²—é«”æ¨™è¨˜ (**)
            const listItems = [
                { 
                    title: "SOP åŸ·è¡Œç¢ºèª", 
                    content: "éƒ¨é–€ä¸»ç®¡æ‡‰é‡å° **é‡é»é—œæ³¨äººå“¡**ï¼Œé€²è¡Œ SOP åŸ·è¡Œç¢ºèªçœ‹ä½œæ¥­å“¡æ˜¯å¦ç†Ÿæ‚‰ï¼Œä»¥ç¢ºä¿æµç¨‹æ­¥é©Ÿç†è§£ç„¡èª¤ã€‚"
                },
                {
                    title: "å³æ™‚å•é¡Œåé¥‹", 
                    content: "å»ºç«‹æ¨™æº–åŒ–çš„ç•°å¸¸è™•ç†æµç¨‹ï¼Œç¢ºä¿ä½œæ¥­å“¡åœ¨é‡åˆ° **ç³»çµ±ã€ç¶²è·¯** å•é¡Œæ™‚ï¼Œæœƒ **å³æ™‚å‘ç¾å ´æŠ€è¡“å“¡æˆ–ä¸»ç®¡åæ‡‰**ã€‚"
                },
                {
                    // ä¿®æ­£ 3: æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ç²¾ç°¡æ–‡å­—
                    title: "é å®šç”Ÿç”¢èµ·è¨–æ—¥", 
                    content: "æª¢è¦–ç•°å¸¸å ±å·¥ä¸­å›  **å·¥å–®é€¾æœŸ** çš„å•é¡Œæ¯”ä¾‹ï¼Œä¸¦è«‹ **ç”Ÿç®¡** ç¢ºèªå·¥å–®çš„ **é å®šå®Œæˆæ—¥** çš„åˆç†æ€§ï¼Œç¢ºä¿å·¥å–®æ™‚ç¨‹ç¬¦åˆç¾å ´ä½œæ¥­éœ€æ±‚ã€‚"
                }
            ];
            
            return { summary: summaryText, list: listItems, isStructured: true };
        }

        // åŒ¯å‡ºå ±è¡¨ç‚ºPDF
        async function exportPdf() {
            const exportBtn = document.getElementById('exportPdfBtn');
            const pdfContentWrapper = document.getElementById('pdfContentWrapper'); // FIX 2: ä½¿ç”¨æ–°çš„ wrapper
            const moldingSection = document.getElementById('moldingSection');
            const assemblySection = document.getElementById('assemblySection');
            const insightsSection = document.getElementById('insightsSection');
            const pdfTitle = document.getElementById('pdfTitle');

            exportBtn.style.display = 'none';
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            try {
                pdfTitle.style.display = 'block';

                // 1. åŒ¯å‡ºæˆå‹éƒ¨é–€ (ç¬¬ä¸€é )
                assemblySection.style.display = 'none';
                insightsSection.style.display = 'none';
                moldingSection.style.display = 'block'; // ç¢ºä¿æˆå‹å¯è¦‹

                const moldingCanvas = await html2canvas(pdfContentWrapper, { scale: 2, useCORS: true }); // FIX 2: æ•ç² wrapper
                const moldingImg = moldingCanvas.toDataURL('image/jpeg', 1.0);
                const moldingWidth = pdf.internal.pageSize.getWidth();
                const moldingHeight = (moldingCanvas.height * moldingWidth) / moldingCanvas.width;
                pdf.addImage(moldingImg, 'JPEG', 0, 0, moldingWidth, moldingHeight);
                
                // 2. åŒ¯å‡ºçµ„è£éƒ¨é–€å’Œæ´å¯Ÿ (æ–°å¢é é¢)
                moldingSection.style.display = 'none'; // éš±è—æˆå‹
                assemblySection.style.display = 'block';
                insightsSection.style.display = 'block';

                const assemblyCanvas = await html2canvas(pdfContentWrapper, { scale: 2, useCORS: true }); // FIX 2: æ•ç² wrapper
                const assemblyImg = assemblyCanvas.toDataURL('image/jpeg', 1.0);
                const assemblyWidth = pdf.internal.pageSize.getWidth();
                const assemblyHeight = (assemblyCanvas.height * assemblyWidth) / assemblyCanvas.width;
                pdf.addPage();
                pdf.addImage(assemblyImg, 'JPEG', 0, 0, assemblyWidth, assemblyHeight);

                pdf.save(`MESç•°å¸¸åˆ†æå ±å‘Š_${document.getElementById('startDate').value.replace(/-/g, '')}-${document.getElementById('endDate').value.replace(/-/g, '')}.pdf`);

            } catch (err) {
                console.error("PDF åŒ¯å‡ºå¤±æ•—: ", err);
                alert("åŒ¯å‡ºå ±è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–é‡æ–°æ•´ç†é é¢ã€‚");
            } finally {
                // æ¢å¾©åŸå§‹é¡¯ç¤ºç‹€æ…‹
                pdfTitle.style.display = 'none';
                moldingSection.style.display = 'block';
                assemblySection.style.display = 'block';
                insightsSection.style.display = 'block';
                exportBtn.style.display = 'block';
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            setupFileUpload();
            document.getElementById('exportPdfBtn').addEventListener('click', exportPdf);
        });
    </script>
</body>
</html>
