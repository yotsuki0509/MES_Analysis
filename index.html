<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå¹³å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼å’ŒéŸ¿æ‡‰å¼è¨­è¨ˆ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', 'Microsoft YaHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 10vh; padding: 20px; font-size: 1.0rem; 
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px); overflow: hidden;
        }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 15px; font-weight: 800; }
        .upload-section { padding: 35px; border-bottom: 2px solid #f0f0f0; }
        .upload-area {
            border: 3px dashed #667eea; border-radius: 15px; padding: 40px; 
            text-align: center; background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease; cursor: pointer;
        }
        .upload-area:hover { background: rgba(102, 126, 234, 0.1); border-color: #5a6fd8; }
        .date-selector { display: flex; gap: 20px; justify-content: center; align-items: center; margin-top: 25px; flex-wrap: wrap; }
        .date-input { padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; }
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 30px; border-radius: 30px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;
        }
        .analyze-btn:disabled { background: #ccc; cursor: not-allowed; }
        .dashboard { padding: 35px 30px; display: none; }
        .dashboard.show { display: block; }
        .date-range-display { text-align: center; background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 30px; font-size: 2.2rem; font-weight: 700; color: #333; }
        .factory-row { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .section-subtitle { font-size: 2.6rem; font-weight: 700; color: #333; margin-bottom: 22px; text-align: center; background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 15px; }
        .factory-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(102, 126, 234, 0.1); }
        .factory-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 15px; text-align: center; padding: 15px; border-radius: 12px; color: white; }
        .molding-title { background: linear-gradient(135deg, #4A90E2, #357ABD); }
        .assembly-title { background: linear-gradient(135deg, #E94B8C, #D63384); }
        .stats-group-title { font-size: 1.4rem; font-weight: 600; color: #4A90E2; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 3px solid #E3F2FD; text-align: left; padding-left: 10px; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 4px 0; }
        .stat-label, .stat-value { font-size: 1.3rem; }
        .stat-value { font-weight: 700; color: #333; }
        .detailed-chart-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 25px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        .detailed-chart-container { height: 380px; padding: 15px; background: #f8f9ff; border-radius: 15px; }
        .full-width-personnel-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 25px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        .personnel-section { padding: 12px; background: #f8f9ff; border-radius: 15px; border-left: 5px solid #4A90E2; }
        .personnel-title { font-size: 1.4rem; font-weight: 700; color: #4A90E2; margin-bottom: 12px; text-align: center; }
        .personnel-item { background: white; padding: 8px 15px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; border-left: 4px solid #E94B8C; font-size: 1.25rem; }
        .insights { background: white; border-radius: 16px; padding: 30px; margin-top: 30px; }
        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .insight-item { background: #f8f9ff; border-left: 5px solid #667eea; padding: 15px; border-radius: 10px; }
        .insight-item h4 { color: #667eea; margin-bottom: 12px; font-size: 1.5rem; font-weight: 700; }
        .insight-content-box { margin-top: 10px; padding: 12px 15px; border-radius: 8px; background-color: white; border: 1px solid #e0e7ff; }
        .insight-content-box li { margin-bottom: 8px; padding-left: 25px; text-indent: -20px; list-style: none; font-size: 1.28rem; }
        .insight-content-box li::before { content: "â”"; font-weight: bold; color: #E94B8C; margin-right: 10px; }
        .loading { display: none; text-align: center; padding: 30px; font-size: 1.4rem; color: #667eea; }
        .loading.show { display: block; }
        @media (min-width: 1024px) { .insight-grid { grid-template-columns: 1fr 1fr; } .insight-item.span-full { grid-column: 1 / 3; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æå¹³å°</h1>
            <p>è£½é€ åŸ·è¡Œç³»çµ± Â· ç¾å ´å ±å·¥æ•¸æ“šåˆ†æ Â· æ™ºèƒ½ç•°å¸¸æª¢æ¸¬--Crafted by å‹å…¨ Â· Powered by AI</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h3>ä¸Šå‚³Excelæª”æ¡ˆæˆ–æ‹–æ‹½è‡³æ­¤</h3>
                <p>æ”¯æ´ .xlsx, .xls æ ¼å¼ï¼Œå°‡è‡ªå‹•è®€å–ã€Œç´€éŒ„å–®ã€å·¥ä½œè¡¨</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="date-selector">
                <div class="date-group">
                    <label for="startDate">çµ±è¨ˆèµ·å§‹æ—¥ï¼š</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <div class="date-group">
                    <label for="endDate">çµ±è¨ˆçµæŸæ—¥ï¼š</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
                <button id="analyzeBtn" class="analyze-btn" disabled>é–‹å§‹åˆ†æ</button>
            </div>
        </div>
        
        <div class="loading" id="loading">ğŸ”„ æ­£åœ¨åˆ†ææ•¸æ“šä¸­...</div>
        
        <div class="dashboard" id="dashboard">
            <div style="text-align: right; margin-bottom: 20px;">
                <button id="exportPdfBtn" class="analyze-btn">åŒ¯å‡ºå ±è¡¨ç‚ºPDF</button>
            </div>
            
            <div id="pdfContentWrapper">
                <div id="pdfTitle" style="display:none; text-align:center; font-size: 40px; font-weight: bold; margin-bottom: 20px;">MESç¾å ´å ±å·¥ç•°å¸¸åˆ†æ</div>
                <div class="date-range-display" id="dateRangeDisplay"></div>
                
                <!-- æˆå‹éƒ¨é–€ -->
                <div id="moldingSection">
                    <div class="section-subtitle">ğŸ”§ æˆå‹éƒ¨é–€ç¾æ³</div>
                    <div class="factory-row">
                        <div class="factory-card">
                            <div class="factory-title molding-title">å®—ç‘‹å»  - æˆå‹éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š ç­åˆ¥çµ±è¨ˆ</div>
                                <div class="stats-row"><span class="stat-label">ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="zongweiMoldingTotal">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">æ—¥ç­ç™¼ç”Ÿ</span><span class="stat-value" id="zongweiMoldingDay">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">å¤œç­ç™¼ç”Ÿ</span><span class="stat-value" id="zongweiMoldingNight">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="zongweiMoldingIssues"></div></div>
                        </div>
                        <div class="factory-card">
                            <div class="factory-title molding-title">åšå£«å»  - æˆå‹éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-group-title">ğŸ“Š ç­åˆ¥çµ±è¨ˆ</div>
                                <div class="stats-row"><span class="stat-label">ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="bossMoldingTotal">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">æ—¥ç­ç™¼ç”Ÿ</span><span class="stat-value" id="bossMoldingDay">0 æ¬¡</span></div>
                                <div class="stats-row"><span class="stat-label">å¤œç­ç™¼ç”Ÿ</span><span class="stat-value" id="bossMoldingNight">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="bossMoldingIssues"></div></div>
                        </div>
                    </div>
                    <div class="detailed-chart-section">
                        <div class="detailed-chart-container"><canvas id="zongweiMoldingDetailedChart"></canvas></div>
                        <div class="detailed-chart-container"><canvas id="bossMoldingDetailedChart"></canvas></div>
                    </div>
                    <div class="full-width-personnel-section">
                        <div class="personnel-section"><div class="personnel-title" id="zongweiMoldingPersonnelTitle">å®—ç‘‹å»  - é—œæ³¨äººå“¡</div><div id="zongweiMoldingPersonnel"></div></div>
                        <div class="personnel-section"><div class="personnel-title" id="bossMoldingPersonnelTitle">åšå£«å»  - é—œæ³¨äººå“¡</div><div id="bossMoldingPersonnel"></div></div>
                    </div>
                </div>
                
                <!-- çµ„è£éƒ¨é–€ (æ¢å¾©é¡¯ç¤º) -->
                <div id="assemblySection" style="margin-top: 50px;">
                    <div class="section-subtitle">ğŸ“¦ çµ„è£éƒ¨é–€ç¾æ³</div>
                    <div class="factory-row">
                        <div class="factory-card">
                            <div class="factory-title assembly-title">å®—ç‘‹å»  - çµ„è£éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-row"><span class="stat-label">ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="zongweiAssemblyTotal">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="zongweiAssemblyIssues"></div></div>
                        </div>
                        <div class="factory-card">
                            <div class="factory-title assembly-title">åšå£«å»  - çµ„è£éƒ¨é–€</div>
                            <div class="stats-section">
                                <div class="stats-row"><span class="stat-label">ä¿®æ­£ç¸½æ¬¡æ•¸</span><span class="stat-value" id="bossAssemblyTotal">0 æ¬¡</span></div>
                            </div>
                            <div class="stats-section"><div class="stats-group-title">âš ï¸ å•é¡Œé¡å‹</div><div id="bossAssemblyIssues"></div></div>
                        </div>
                    </div>
                </div>
                
                <div class="insights" id="insightsSection">
                    <div class="section-subtitle">ğŸ“Š å®¢è§€ç¾æ³è§€å¯Ÿèˆ‡å»ºè­°</div>
                    <div class="insight-grid" id="insightsGrid"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let excelData = [];
        let charts = {};
        const MAIN_ISSUES = ['æ¼å ±å·¥', 'æ•¸é‡éŒ¯èª¤', 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)', 'å…¶ä»–/æœªåˆ†é¡'];
        
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
            const fmt = (d) => d.toISOString().split('T')[0];
            document.getElementById('startDate').value = fmt(firstDay);
            document.getElementById('endDate').value = fmt(lastDay);
        }

        function setupFileUpload() {
            const area = document.getElementById('uploadArea');
            const input = document.getElementById('fileInput');
            area.onclick = () => input.click();
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const sheet = wb.Sheets['ç´€éŒ„å–®'] || wb.Sheets[wb.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(sheet);
                    document.getElementById('analyzeBtn').disabled = false;
                    area.querySelector('h3').textContent = `å·²è¼‰å…¥: ${e.target.files[0].name}`;
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            };
        }

        function analyzeData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const filtered = excelData.filter(row => {
                const d = row['èª¿æ•´æ—¥æœŸ'];
                if(!d) return false;
                const ds = typeof d === 'number' ? new Date((d - 25569) * 86400000).toISOString().split('T')[0] : String(d);
                return ds >= start && ds <= end;
            });
            if(!filtered.length) return alert('æ­¤å€é–“ç„¡æ•¸æ“š');
            document.getElementById('loading').classList.add('show');
            setTimeout(() => {
                const stats = processStats(filtered);
                renderDashboard(stats, start, end);
                document.getElementById('loading').classList.remove('show');
                document.getElementById('dashboard').classList.add('show');
            }, 100);
        }

        function processStats(data) {
            const res = { å®—ç‘‹å» : { æˆå‹: {total:0, day:0, night:0, issues:{}, personnel:{}, raw:[]}, çµ„è£: {total:0, issues:{}} }, åšå£«å» : { æˆå‹: {total:0, day:0, night:0, issues:{}, personnel:{}, raw:[]}, çµ„è£: {total:0, issues:{}} } };
            data.forEach(row => {
                const f = row['å» åˆ¥']?.includes('å®—ç‘‹') ? 'å®—ç‘‹å» ' : (row['å» åˆ¥']?.includes('åšå£«') ? 'åšå£«å» ' : null);
                const d = row['éƒ¨é–€']?.includes('æˆå‹') ? 'æˆå‹' : (row['éƒ¨é–€']?.includes('çµ„è£') ? 'çµ„è£' : null);
                if(!f || !d) return;
                const target = res[f][d];
                target.total++;
                const reason = getReason(row);
                target.issues[reason] = (target.issues[reason] || 0) + 1;
                if(d === 'æˆå‹') {
                    row['ç­åˆ¥']?.includes('å¤œ') ? target.night++ : target.day++;
                    target.raw.push(row);
                    const p = row['å ±å·¥äººå“¡1'];
                    if(p) p.split('/').forEach(n => { const nm = n.trim(); if(nm) target.personnel[nm] = (target.personnel[nm] || 0) + 1; });
                }
            });
            return res;
        }

        function getReason(row) {
            const r = row['èª¿æ•´åŸå› ']?.toString() || '';
            if(r.includes('æ¼å ±å·¥')) return 'æ¼å ±å·¥';
            if(r.includes('æ•¸é‡éŒ¯èª¤')) return 'æ•¸é‡éŒ¯èª¤';
            if(r.includes('æœªé€å•Ÿå§‹ä»¶')) return 'æœªé€å•Ÿå§‹ä»¶(å¾Œè£œ)';
            return 'å…¶ä»–/æœªåˆ†é¡';
        }

        function renderDashboard(stats, start, end) {
            document.getElementById('dateRangeDisplay').textContent = `${start.replace(/-/g, '/')} ~ ${end.replace(/-/g, '/')} ç•°å¸¸åˆ†æ`;
            const moldingTotal = stats['å®—ç‘‹å» ']['æˆå‹'].total + stats['åšå£«å» ']['æˆå‹'].total;
            
            ['å®—ç‘‹å» ', 'åšå£«å» '].forEach(f => {
                const pref = f === 'å®—ç‘‹å» ' ? 'zongwei' : 'boss';
                const m = stats[f]['æˆå‹'];
                document.getElementById(`${pref}MoldingTotal`).textContent = `${m.total} æ¬¡`;
                document.getElementById(`${pref}MoldingDay`).textContent = `${m.day} æ¬¡ (${(m.day/moldingTotal*100).toFixed(1)}%)`;
                document.getElementById(`${pref}MoldingNight`).textContent = `${m.night} æ¬¡ (${(m.night/moldingTotal*100).toFixed(1)}%)`;
                renderIssues(`${pref}MoldingIssues`, m.issues, m.total);
                
                const a = stats[f]['çµ„è£'];
                document.getElementById(`${pref}AssemblyTotal`).textContent = `${a.total} æ¬¡`;
                renderIssues(`${pref}AssemblyIssues`, a.issues, a.total);
                
                const pList = Object.entries(m.personnel).filter(x => x[1] > 3).sort((a,b)=>b[1]-a[1]);
                document.getElementById(`${pref}MoldingPersonnelTitle`).textContent = `${f} - é—œæ³¨äººå“¡ (${pList.length}ä½)`;
                document.getElementById(`${pref}MoldingPersonnel`).innerHTML = pList.length ? `<ul class="personnel-list">` + pList.map(x => `<li class="personnel-item"><span>${x[0]}</span><span>${x[1]}æ¬¡</span></li>`).join('') + `</ul>` : 'âœ… è¡¨ç¾ç©©å®š';
            });
            renderCharts(stats);
            renderInsights(stats);
        }

        function renderIssues(id, issues, total) {
            const el = document.getElementById(id);
            if(!total) return el.innerHTML = 'âœ… ç„¡ç•°å¸¸';
            el.innerHTML = Object.entries(issues).sort((a,b)=>b[1]-a[1]).map(i => `<div class="stats-row"><span class="stat-label">${i[0]}</span><span class="stat-value">${i[1]}æ¬¡</span></div>`).join('');
        }

        function renderCharts(stats) {
            Object.keys(charts).forEach(k => charts[k].destroy());
            ['zongwei', 'boss'].forEach(f => {
                const data = stats[f === 'zongwei' ? 'å®—ç‘‹å» ' : 'åšå£«å» ']['æˆå‹'];
                const ctx = document.getElementById(`${f}MoldingDetailedChart`).getContext('2d');
                const labels = MAIN_ISSUES.slice(0, 3);
                charts[f] = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [
                        { label: 'æ—¥ç­', data: labels.map(l => data.raw.filter(r => !r['ç­åˆ¥']?.includes('å¤œ') && getReason(r) === l).length), backgroundColor: '#4A90E2' },
                        { label: 'å¤œç­', data: labels.map(l => data.raw.filter(r => r['ç­åˆ¥']?.includes('å¤œ') && getReason(r) === l).length), backgroundColor: '#E94B8C' }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false }
                });
            });
        }

        function renderInsights(stats) {
            const zm = stats['å®—ç‘‹å» ']['æˆå‹'], bm = stats['åšå£«å» ']['æˆå‹'];
            const total = zm.total + bm.total;
            const issues = {};
            [zm, bm].forEach(d => Object.entries(d.issues).forEach(([k,v]) => issues[k] = (issues[k] || 0) + v));
            const topIssue = Object.entries(issues).sort((a,b)=>b[1]-a[1])[0][0];

            const zmPct = (zm.total/total*100).toFixed(1), bmPct = (bm.total/total*100).toFixed(1);
            const nightTotal = zm.night + bm.night;

            const recs = [
                { title: "SOP åŸ·è¡Œç¢ºèª", content: "éƒ¨é–€ä¸»ç®¡æ‡‰é‡å° **é‡é»é—œæ³¨äººå“¡** é€²è¡Œç¾å ´æŸ¥æ ¸ï¼Œç¢ºä¿å ±å·¥æ­¥é©Ÿèˆ‡å¯¦éš›ä½œæ¥­æµç¨‹åŒæ­¥ã€‚" },
                { title: "å³æ™‚å•é¡Œåé¥‹", content: "è‹¥é‡ç³»çµ±é€£ç·šä¸ç©©ï¼Œæ‡‰ç¬¬ä¸€æ™‚é–“é€šçŸ¥æŠ€è¡“å“¡ï¼Œé¿å…äº‹å¾Œå› æ†‘è¨˜æ†¶è£œå–®é€ æˆçš„æ•¸æ“šåå·®ã€‚" },
                { title: "é ˜ç­é¢å¯©å ±å·¥åˆ¶", content: `é‡å° **${topIssue}** å•é¡Œï¼Œæ‡‰è½å¯¦é¢å¯©æ©Ÿåˆ¶ï¼šè¦æ±‚ä½œæ¥­å“¡æ–¼ä¸‹ç­å‰ï¼Œæ”œå¸¶ç´™æœ¬å·¥å–®èˆ‡ iPad è‡³æŠ€è¡“å“¡/é ˜ç­è™•ï¼Œç•¶é¢æ ¸å°ç”Ÿç”¢æ•¸èˆ‡å ±å·¥æ•¸ï¼Œç¢ºèªç„¡èª¤å¾Œå†è¡Œä¸‹ç­ã€‚` }
            ];
            if (nightTotal > total * 0.4) recs[1] = { title: "å¤œç­å¼·åŒ–ç›£ç£", content: "å¤œç­ç•°å¸¸æ¯”ä¾‹è¼ƒé«˜ï¼ŒæŠ€è¡“å“¡æ‡‰æ–¼ä¸‹ç­å‰ 30 åˆ†é˜åŠ å¼·å·¡æŸ¥ï¼Œç¢ºä¿å¤œç­å ±å·¥æ•¸æ“šä¹‹æº–ç¢ºåº¦ã€‚" };

            const grid = document.getElementById('insightsGrid');
            grid.innerHTML = `
                <div class="insight-item">
                    <h4>ğŸ”§ æˆå‹å» å€è¶¨å‹¢è§€å¯Ÿ</h4>
                    <div class="insight-content-box"><p>æœ¬æœˆæˆå‹ç¸½ç•°å¸¸ **${total}** æ¬¡ã€‚
